<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BLE 扫描 + NUS 串口终端（可配置）</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 16px; }
    button { padding: 10px 14px; margin-right: 8px; }
    input[type="text"] { padding: 10px 12px; width: 100%; box-sizing: border-box; }
    .hint { color: #666; margin: 10px 0 14px; line-height: 1.5; }
    .row { margin: 10px 0; }
    .label { font-weight: 600; margin-bottom: 6px; }
    .subhint { color: #666; font-size: 13px; line-height: 1.5; margin-top: 6px; }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    th, td { border: 1px solid #ddd; padding: 8px; font-size: 14px; vertical-align: top; }
    th { background: #f6f6f6; text-align: left; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    #log { white-space: pre-wrap; background: #0b1020; color: #d7e3ff; padding: 10px; border-radius: 8px; margin-top: 12px; }
    .btnSmall { padding: 6px 10px; margin: 0; }
    .btnSmall[disabled] { opacity: 0.6; }
    details { margin: 8px 0; }
    .svc { margin: 8px 0 10px; }
    .svcTitle { font-weight: 600; }
    .chip { display: inline-block; padding: 2px 6px; border: 1px solid #ddd; border-radius: 999px; margin-left: 6px; font-size: 12px; color: #444; }
    .err { color: #b00020; }
    .ok  { color: #0a7a2f; }

    /* NUS Terminal */
    .termWrap { margin-top: 10px; border: 1px solid #ddd; border-radius: 10px; padding: 10px; }
    .termHead { display: flex; align-items: center; justify-content: space-between; gap: 8px; margin-bottom: 8px; }
    .termTitle { font-weight: 700; }
    .termBody { background: #0b1020; color: #d7e3ff; border-radius: 8px; padding: 10px; min-height: 120px; max-height: 260px; overflow: auto; white-space: pre-wrap; }
    .termControls { display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap; }
    .termControls input[type="text"] { flex: 1; min-width: 180px; }
    .termMeta { font-size: 12px; color: #666; margin-top: 6px; line-height: 1.4; }
    .pill { display:inline-block; padding:2px 8px; border:1px solid #ddd; border-radius:999px; font-size:12px; color:#444; }
  </style>
</head>
<body>
  <h2>BLE 扫描 + NUS 串口终端（可配置）</h2>

  <div class="hint">
    <b>环境：</b>必须 HTTPS 或 localhost。<br/>
    <b>RSSI 扫描：</b>安卓 Chrome 通常需要开启实验特性：
    <span class="mono">chrome://flags/#enable-experimental-web-platform-features</span>。<br/>
    <b>注意：</b>Web 端拿不到 BLE 真实 MAC；访问 GATT 服务需要在 requestDevice 时声明 optionalServices。
  </div>

  <div class="row">
    <div class="label">可访问服务（optionalServices，逗号分隔）</div>
    <input id="svcInput" type="text" value="1800,1801,fe59,180a,180f,6e400001-b5a3-f393-e0a9-e50e24dcca9e" />
    <div class="subhint">建议包含 NUS：<span class="mono">6e400001-b5a3-f393-e0a9-e50e24dcca9e</span></div>
  </div>

  <div class="row">
    <div class="label">RSSI 过滤阈值（dBm，仅显示大于该值的设备；过滤掉无名称设备）</div>
    <input id="rssiInput" type="text" value="-80" />
    <div class="subhint">例：-60 表示只显示信号强于 -60 dBm 的设备（-50 会显示，-70 不显示）</div>
  </div>

  <div>
    <button id="btnStart">开始扫描</button>
    <button id="btnStop" disabled>停止扫描</button>
    <button id="btnClear">清空列表</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>名称</th>
        <th>RSSI</th>
        <th>最近一次出现</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <div id="log"></div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);
  const tbody = $("tbody");
  const logEl = $("log");
  const btnStart = $("btnStart");
  const btnStop = $("btnStop");
  const btnClear = $("btnClear");
  const svcInput = $("svcInput");
  const rssiInput = $("rssiInput");

  const MAX_AGE_MS = 10_000;
  const REFRESH_MS = 500;

  const NUS_SERVICE_UUID = "6e400001-b5a3-f393-e0a9-e50e24dcca9e";
  const NUS_WRITE_UUID   = "6e400002-b5a3-f393-e0a9-e50e24dcca9e";
  const NUS_NOTIFY_UUID  = "6e400003-b5a3-f393-e0a9-e50e24dcca9e";

  let scan = null;
  let refreshTimer = null;
  const rows = new Map();

  const NAME_TO_16BIT = new Map(Object.entries({
    generic_access: "1800",
    generic_attribute: "1801",
    device_information: "180A",
    battery_service: "180F",
    secure_dfu: "FE59",
    secure_dfu_service: "FE59"
  }));

  function log(msg) {
    const t = new Date().toLocaleString();
    logEl.textContent = `[${t}] ${msg}\n` + logEl.textContent;
  }

  function ensureRefreshTimer() {
    if (refreshTimer !== null) return;
    refreshTimer = window.setInterval(refreshView, REFRESH_MS);
  }

  function getRssiThreshold() {
    const v = (rssiInput && rssiInput.value != null) ? String(rssiInput.value).trim() : "";
    const n = Number(v);
    if (!Number.isFinite(n)) return -999;
    return n;
  }

  function hasName(name) {
    const s = String(name || "").trim();
    return s.length > 0;
  }

  function uuidEq(a, b) {
    return String(a||"").toLowerCase() === String(b||"").toLowerCase();
  }
  function isNusServiceUuid(u) { return uuidEq(u, NUS_SERVICE_UUID); }

  function setButtonState(entry, state) {
    const btn = entry.tr?.querySelector("button.connect");
    const badge = entry.tr?.querySelector(".status");
    if (!btn || !badge) return;

    if (state === "idle") {
      btn.disabled = false;
      btn.textContent = "连接";
      badge.textContent = "";
      badge.className = "chip status";
    } else if (state === "connecting") {
      btn.disabled = true;
      btn.textContent = "连接中…";
      badge.textContent = "连接中";
      badge.className = "chip status";
    } else if (state === "connected") {
      btn.disabled = false;
      btn.textContent = "断开";
      badge.textContent = "已连接";
      badge.className = "chip status ok";
    }
  }

  function ensureRows(entry) {
    if (entry.tr) return;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="name"></td>
      <td class="mono rssi"></td>
      <td class="mono last"></td>
      <td>
        <button class="btnSmall connect" type="button">连接</button>
        <span class="chip status"></span>
      </td>
    `;

    const detailsTr = document.createElement("tr");
    detailsTr.style.display = "none";
    detailsTr.innerHTML = `
      <td colspan="4">
        <details open>
          <summary>服务与特征（Service / Characteristic）</summary>
          <div class="detailBody">(未连接)</div>
        </details>
      </td>
    `;

    entry.tr = tr;
    entry.detailsTr = detailsTr;

    tr.querySelector("button.connect").addEventListener("click", async () => {
      if (entry.connected) await disconnectEntry(entry);
      else await connectEntry(entry);
    });

    tbody.appendChild(tr);
    tbody.appendChild(detailsTr);
  }

  function upsertRow({ name, id, rssi, advDevice }) {
    const now = Date.now();
    let entry = rows.get(id);

    if (!entry) {
      entry = {
        tr: null, detailsTr: null,
        lastSeenMs: now,
        rssi: undefined,
        name: "",
        advDevice: null,
        grantedDevice: null,
        gattServer: null,
        connected: false,
        connecting: false,
        nus: null
      };
      rows.set(id, entry);
    }

    ensureRows(entry);

    entry.lastSeenMs = now;
    entry.name = name || "(无名称)";
    if (typeof rssi === "number") entry.rssi = rssi;
    if (advDevice) entry.advDevice = advDevice;

    entry.tr.querySelector(".name").textContent = entry.name;
    entry.tr.querySelector(".rssi").textContent = (typeof entry.rssi === "number") ? `${entry.rssi} dBm` : "(未知)";
    entry.tr.querySelector(".last").textContent = new Date(now).toLocaleTimeString();

    refreshView();
  }

  function refreshView() {
    const now = Date.now();
    for (const [id, entry] of rows.entries()) {
      if (entry.connected) continue;
      if (now - entry.lastSeenMs > MAX_AGE_MS) {
        entry.tr?.remove();
        entry.detailsTr?.remove();
        rows.delete(id);
      }
    }

    const entries = Array.from(rows.values());
    entries.sort((a, b) => {
      const ar = (typeof a.rssi === "number") ? a.rssi : -Infinity;
      const br = (typeof b.rssi === "number") ? b.rssi : -Infinity;
      if (br !== ar) return br - ar;
      return b.lastSeenMs - a.lastSeenMs;
    });

    for (const e of entries) {
      tbody.appendChild(e.tr);
      tbody.appendChild(e.detailsTr);
    }
  }

  function clearTable() {
    for (const entry of rows.values()) {
      try { entry.gattServer?.device?.gatt?.disconnect(); } catch (_) {}
      try { entry.grantedDevice?.gatt?.disconnect(); } catch (_) {}
    }
    rows.clear();
    tbody.innerHTML = "";
    log("已清空列表（并尝试断开所有连接）");
  }

  function focusOnEntry(keepEntry) {
    for (const [id, entry] of rows.entries()) {
      if (entry === keepEntry) continue;
      entry.tr?.remove();
      entry.detailsTr?.remove();
      rows.delete(id);
    }
    if (keepEntry?.tr) tbody.appendChild(keepEntry.tr);
    if (keepEntry?.detailsTr) tbody.appendChild(keepEntry.detailsTr);
  }

  function normalizeServiceToken(token) {
    const t = String(token || "").trim();
    if (!t) return null;

    if (/^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/.test(t)) {
      return { kind: "uuid", value: t.toLowerCase() };
    }

    let hex = t.toLowerCase();
    if (hex.startsWith("0x")) hex = hex.slice(2);
    if (/^[0-9a-f]{4}$/.test(hex)) {
      const full = `0000${hex}-0000-1000-8000-00805f9b34fb`;
      return { kind: "uuid", value: full };
    }

    const key = t.toLowerCase().replace(/\s+/g, "_");
    if (NAME_TO_16BIT.has(key)) {
      const h = NAME_TO_16BIT.get(key).toLowerCase();
      const full = `0000${h}-0000-1000-8000-00805f9b34fb`;
      return { kind: "uuid", value: full };
    }

    return { kind: "name", value: key };
  }

  function getOptionalServices() {
    const raw = svcInput.value || "";
    const tokens = raw.split(",").map(s => s.trim()).filter(Boolean);
    const normalized = [];
    for (const tok of tokens) {
      const r = normalizeServiceToken(tok);
      if (!r) continue;
      normalized.push(r.value);
    }
    return Array.from(new Set(normalized));
  }

  async function startScan() {
    if (!("bluetooth" in navigator)) {
      log("当前浏览器不支持 Web Bluetooth（navigator.bluetooth 不存在）");
      return;
    }

    if (typeof navigator.bluetooth.requestLEScan === "function") {
      try {
        scan = await navigator.bluetooth.requestLEScan({ acceptAllAdvertisements: true });
        navigator.bluetooth.addEventListener("advertisementreceived", onAdv);
        btnStart.disabled = true;
        btnStop.disabled = false;
        ensureRefreshTimer();
        log("开始扫描：requestLEScan 已启动（将持续接收周边广播事件）");
        return;
      } catch (e) {
        log("requestLEScan 启动失败：" + (e?.message || e));
        log("将尝试降级到 requestDevice（只能手动选设备，且通常拿不到 RSSI）");
      }
    } else {
      log("当前浏览器没有 requestLEScan（Scanning API 不可用）。尝试降级到 requestDevice。");
    }

    try {
      const device = await navigator.bluetooth.requestDevice({
        acceptAllDevices: true,
        optionalServices: getOptionalServices()
      });
      if (!hasName(device.name)) log("已选择设备但名称为空：按规则不加入列表");
      else log("提示：requestDevice 降级路径通常拿不到 RSSI；为遵循 RSSI 过滤，这里不加入列表");
      ensureRefreshTimer();
      log(`已选择设备：${device.name || "(无名称)"}`);
    } catch (e) {
      log("requestDevice 失败：" + (e?.message || e));
    }
  }

  function stopScan() {
    try { scan?.stop(); } catch (_) {}
    scan = null;

    navigator.bluetooth.removeEventListener("advertisementreceived", onAdv);
    btnStart.disabled = false;
    btnStop.disabled = true;

    ensureRefreshTimer();
    log("已停止扫描（列表将仅保留最近10秒出现的设备；已连接设备不会自动消失）");
  }

  function onAdv(event) {
    const dev = event.device;

    const name = dev?.name;
    if (!hasName(name)) return;

    const th = getRssiThreshold();
    const rssi = event.rssi;
    if (typeof rssi !== "number") return;
    if (rssi <= th) return;

    upsertRow({ name, id: dev?.id || "(unknown-id)", rssi, advDevice: dev });
  }

  async function connectEntry(entry) {
    if (!("bluetooth" in navigator)) {
      log("当前浏览器不支持 Web Bluetooth。");
      return;
    }
    if (entry.connecting) return;

    entry.connecting = true;
    setButtonState(entry, "connecting");

    try {
      const optionalServices = getOptionalServices();
      let device = await navigator.bluetooth.requestDevice({
        filters: [{ name: entry.name }],
        optionalServices
      });

      entry.grantedDevice = device;

      device.addEventListener("gattserverdisconnected", () => {
        entry.connected = false;
        entry.connecting = false;
        entry.gattServer = null;
        entry.nus = null;
        setButtonState(entry, "idle");
        showDetails(entry, "(已断开)", true);
        log(`设备断开：${device.name || "(无名称)"}`);
      });

      const server = await device.gatt.connect();
      entry.gattServer = server;
      entry.connected = true;
      entry.connecting = false;
      setButtonState(entry, "connected");
      log(`已连接：${device.name || "(无名称)"}`);

      stopScan();
      focusOnEntry(entry);

      await enumerateGATT(entry, server, optionalServices);
    } catch (e) {
      entry.connecting = false;
      entry.connected = false;
      entry.gattServer = null;
      entry.nus = null;
      setButtonState(entry, "idle");
      showDetails(entry, `<span class="err">连接/枚举失败：${escapeHtml(e?.message || e)}</span>`, true);
      log("连接/枚举失败：" + (e?.message || e));
    }
  }

  async function disconnectEntry(entry) {
    try {
      const device = entry.grantedDevice || entry.advDevice || entry.gattServer?.device;
      if (device?.gatt?.connected) device.gatt.disconnect();
    } catch (_) {}

    entry.connected = false;
    entry.connecting = false;
    entry.gattServer = null;
    entry.nus = null;
    setButtonState(entry, "idle");
    showDetails(entry, "(已断开)", true);
    log(`已断开：${entry.grantedDevice?.name || entry.name || "(无名称)"}`);
  }

  function showDetails(entry, html, open) {
    if (!entry.detailsTr) return;
    const details = entry.detailsTr.querySelector("details");
    const body = entry.detailsTr.querySelector(".detailBody");
    if (body) body.innerHTML = html;
    entry.detailsTr.style.display = "";
    if (details && open) details.open = true;
  }

  function fmtHex(u8) { return Array.from(u8).map(b => b.toString(16).padStart(2, "0")).join(" "); }

  function appendTerm(entry, line) {
    const el = entry?.nus?.termEl;
    if (!el) return;
    el.textContent += line + "\n";
    el.scrollTop = el.scrollHeight;
  }

  async function writeChunked(ch, data, withoutResponse) {
    const CHUNK = 20;
    for (let off = 0; off < data.length; off += CHUNK) {
      const slice = data.slice(off, off + CHUNK);
      if (withoutResponse && ch.writeValueWithoutResponse) await ch.writeValueWithoutResponse(slice);
      else await ch.writeValue(slice);
      await new Promise(r => setTimeout(r, 10));
    }
  }

  async function setupNusTerminal(entry) {
    if (!entry?.nus) return;
    const wrap = entry.detailsTr?.querySelector(".nusWrap");
    if (!wrap) return;

    entry.nus.termEl = wrap.querySelector(".termBody");
    const input = wrap.querySelector(".termInput");
    const btnSend = wrap.querySelector(".termSend");
    const btnClear = wrap.querySelector(".termClear");

    const btnSub = wrap.querySelector(".nusSub");
    const btnUnsub = wrap.querySelector(".nusUnsub");

    const chkHexRx = wrap.querySelector(".termHexRx");
    const chkSendHex = wrap.querySelector(".termSendHex");
    const chkNoRsp = wrap.querySelector(".termNoRsp");
    const chkCrlf = wrap.querySelector(".termCrlf");
    const chkLf = wrap.querySelector(".termLf");

    const writeChar = entry.nus.writeChar;
    const allNotify = entry.nus.notifyChars || [];
    entry.nus.subscribed = new Map(); // uuid -> { ch, handler }

    const decoder = new TextDecoder("utf-8");

    function parseHexString(s) {
      const t = String(s || "").trim();
      if (!t) return null;
      let bytes = [];
      if (/\s/.test(t)) {
        const toks = t.split(/\s+/).filter(Boolean).map(x => x.toLowerCase().replace(/^0x/, ""));
        for (const tok of toks) {
          if (!/^[0-9a-f]{2}$/.test(tok)) return null;
          bytes.push(parseInt(tok, 16));
        }
      } else {
        const hex = t.toLowerCase().replace(/^0x/, "");
        if (hex.length % 2 !== 0) return null;
        if (!/^[0-9a-f]+$/.test(hex)) return null;
        for (let i = 0; i < hex.length; i += 2) bytes.push(parseInt(hex.slice(i, i + 2), 16));
      }
      return new Uint8Array(bytes);
    }

    function getSelectedNotifyUuids() {
      const cbs = Array.from(wrap.querySelectorAll("input.nusNotifySel"));
      return cbs.filter(cb => cb.checked).map(cb => cb.getAttribute("data-uuid"));
    }

    async function subscribeSelected() {
      const selected = getSelectedNotifyUuids().filter(Boolean);
      if (!selected.length) {
        appendTerm(entry, "[INFO] 未选中任何 notify 特征");
        return;
      }

      for (const uuid of selected) {
        if (entry.nus.subscribed.has(uuid)) {
          appendTerm(entry, `[INFO] 已订阅（跳过）：${uuid}`);
          continue;
        }
        const ch = allNotify.find(x => x.uuid.toLowerCase() === String(uuid).toLowerCase());
        if (!ch) {
          appendTerm(entry, `[ERR] 未找到该 notify 特征：${uuid}`);
          continue;
        }

        try {
          await ch.startNotifications();
          const handler = (ev) => {
            const dv = ev.target.value;
            const u8 = new Uint8Array(dv.buffer.slice(dv.byteOffset, dv.byteOffset + dv.byteLength));
            const asText = (() => { try { return decoder.decode(u8); } catch { return ""; } })();
            const asHex = fmtHex(u8);
            const tag = ch.uuid.toLowerCase().slice(0, 8);
            if (chkHexRx && chkHexRx.checked) appendTerm(entry, `[RX ${tag}] ${asHex}`);
            else appendTerm(entry, `[RX ${tag}] ${asText || asHex}`);
          };
          ch.addEventListener("characteristicvaluechanged", handler);
          entry.nus.subscribed.set(uuid, { ch, handler });
          appendTerm(entry, `[INFO] 已订阅 notify: ${ch.uuid}`);
        } catch (e) {
          appendTerm(entry, `[ERR] 订阅 notify 失败: ${uuid} / ${e?.message || e}`);
        }
      }
    }

    async function unsubscribeAll() {
      for (const [uuid, rec] of entry.nus.subscribed.entries()) {
        try {
          rec.ch.removeEventListener("characteristicvaluechanged", rec.handler);
          if (rec.ch.stopNotifications) await rec.ch.stopNotifications();
          appendTerm(entry, `[INFO] 已取消订阅: ${uuid}`);
        } catch (e) {
          appendTerm(entry, `[ERR] 取消订阅失败: ${uuid} / ${e?.message || e}`);
        }
      }
      entry.nus.subscribed.clear();
    }

    if (!writeChar) {
      appendTerm(entry, "[ERR] 未找到可写 Characteristic（NUS RX）");
      if (btnSend) btnSend.disabled = true;
    } else {
      appendTerm(entry, `[INFO] 可写 characteristic: ${writeChar.uuid}`);
    }

    if (btnClear) btnClear.addEventListener("click", () => { if (entry?.nus?.termEl) entry.nus.termEl.textContent = ""; });
    if (btnSub) btnSub.addEventListener("click", () => subscribeSelected());
    if (btnUnsub) btnUnsub.addEventListener("click", () => unsubscribeAll());

    if (btnSend) {
      btnSend.addEventListener("click", async () => {
        const raw = String(input?.value || "");
        if (!raw || !writeChar) return;

        try {
          let data = null;

          if (chkSendHex && chkSendHex.checked) {
            const u8 = parseHexString(raw);
            if (!u8) { appendTerm(entry, "[ERR] HEX 格式不合法。示例：01 ff 0a 或 01ff0a"); return; }
            data = u8;
          } else {
            let text = raw;
            const crlf = !!(chkCrlf && chkCrlf.checked);
            const lf = !!(chkLf && chkLf.checked);
            if (crlf) text += "\r\n";
            else if (lf) text += "\n";
            data = new TextEncoder().encode(text);
          }

          const withoutResponse = !!(chkNoRsp && chkNoRsp.checked);
          await writeChunked(writeChar, data, withoutResponse);

          if (chkSendHex && chkSendHex.checked) appendTerm(entry, `[TX HEX] ${fmtHex(data)}`);
          else appendTerm(entry, `[TX] ${raw}`);

          if (input) input.value = "";
        } catch (e) {
          appendTerm(entry, `[ERR] 发送失败: ${e?.message || e}`);
        }
      });
    }

    if (input) input.addEventListener("keydown", (e) => { if (e.key === "Enter") btnSend?.click(); });

    const selected = getSelectedNotifyUuids();
    if (selected.length) appendTerm(entry, `[INFO] 已默认选中 notify：${selected.join(", ")}（点击“订阅选中”开始接收）`);
  }

  async function enumerateGATT(entry, server, optionalServices) {
    try {
      const services = await server.getPrimaryServices();
      const allowNote = optionalServices?.length
        ? `<div class="subhint">当前允许访问的服务数量：<span class="mono">${optionalServices.length}</span>（只会显示这些范围内能访问到的服务）</div>`
        : `<div class="subhint err">optionalServices 为空：浏览器会拒绝访问任何服务。请在上方输入服务 UUID/别名后再连接。</div>`;

      if (!services || services.length === 0) {
        showDetails(entry, `${allowNote}<div>(未发现可访问的 Primary Services)</div>`, true);
        return;
      }

      const parts = [allowNote];

      for (const svc of services) {
        let chars = null;
        try { chars = await svc.getCharacteristics(); } catch (e) { chars = null; }
        const svcUuid = svc.uuid;

        let isNus = false;
        let nusWrite = null;
        let nusNotifies = [];

        if (isNusServiceUuid(svcUuid)) {
          isNus = true;
          if (chars && chars.length) {
            for (const ch of chars) {
              const p = ch.properties;
              const cu = (ch.uuid || "").toLowerCase();
              if ((p.write || p.writeWithoutResponse) && !nusWrite) nusWrite = ch;
              if ((p.notify || p.indicate)) nusNotifies.push(ch);
              if (uuidEq(cu, NUS_WRITE_UUID)) nusWrite = ch;
              if (uuidEq(cu, NUS_NOTIFY_UUID)) nusNotifies = [ch, ...nusNotifies.filter(x => x !== ch)];
            }
          }
          entry.nus = { serviceUuid: svcUuid, writeChar: nusWrite, notifyChars: nusNotifies, termEl: null, subscribed: null };
        }

        let svcBlock = `<div class="svc"><div class="svcTitle">Service: <span class="mono">${escapeHtml(svcUuid)}</span></div>`;
        if (!chars) {
          svcBlock += `<div class="err">无法读取 Characteristics（可能未将该服务加入 optionalServices 或设备限制）</div>`;
        } else if (chars.length === 0) {
          svcBlock += `<div>(无 Characteristics)</div>`;
        } else {
          svcBlock += `<ul>`;
          for (const ch of chars) {
            const props = [];
            const p = ch.properties;
            if (p.read) props.push("read");
            if (p.write) props.push("write");
            if (p.writeWithoutResponse) props.push("writeWithoutResponse");
            if (p.notify) props.push("notify");
            if (p.indicate) props.push("indicate");
            if (p.authenticatedSignedWrites) props.push("signedWrites");

            svcBlock += `<li>
              <span>Characteristic: <span class="mono">${escapeHtml(ch.uuid)}</span></span>
              <span class="chip">${escapeHtml(props.join(", ") || "no-props")}</span>
            </li>`;
          }
          svcBlock += `</ul>`;
        }

        if (isNus) {
          const w = entry.nus?.writeChar?.uuid || "(未找到)";
          const nList = (entry.nus?.notifyChars || []).map(x => x.uuid);
          const n = nList.join(", ") || "(未找到)";
          const nItems = nList.map((u, idx) => {
            const checked = (idx === 0) ? "checked" : "";
            return `<label style="display:block;margin:2px 0;"><input type="checkbox" class="nusNotifySel" data-uuid="${escapeHtml(u)}" ${checked}/> <span class="mono">${escapeHtml(u)}</span></label>`;
          }).join("") || `<div class="subhint err">未发现 notify 特征</div>`;

          svcBlock += `
            <div class="termWrap nusWrap">
              <div class="termHead">
                <div class="termTitle">NUS 串口终端</div>
                <span class="pill">可配置</span>
              </div>

              <div class="termMeta">
                <div class="subhint">Write: <span class="mono">${escapeHtml(w)}</span></div>
                <div class="subhint">Notify: <span class="mono">${escapeHtml(n)}</span></div>
              </div>

              <div class="termMeta" style="margin-top:8px;">
                <div class="label" style="font-weight:600;margin-bottom:6px;">Notify 订阅（可选）</div>
                <div class="nusNotifyList">${nItems}</div>
                <div class="termControls" style="margin-top:8px;">
                  <button class="btnSmall nusSub" type="button">订阅选中</button>
                  <button class="btnSmall nusUnsub" type="button">取消订阅</button>
                  <label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" class="termHexRx" /> RX 以 HEX 显示</label>
                </div>
              </div>

              <div class="termBody"></div>

              <div class="termControls">
                <input class="termInput" type="text" placeholder="输入要发送的文本或 HEX（如：01 ff 0a），回车发送" />
                <button class="btnSmall termSend" type="button">发送</button>
                <button class="btnSmall termClear" type="button">清空</button>
              </div>

              <div class="termMeta">
                <label style="margin-right:12px;"><input type="checkbox" class="termSendHex" /> 发送 HEX</label>
                <label style="margin-right:12px;"><input type="checkbox" class="termNoRsp" checked /> writeWithoutResponse</label>
                <label style="margin-right:12px;"><input type="checkbox" class="termCrlf" /> 追加 \r\n</label>
                <label><input type="checkbox" class="termLf" /> 追加 \n</label>
                <div class="subhint">说明：默认按 UTF-8 发送文本；长数据会按 20 bytes 分包写入。</div>
              </div>
            </div>
          `;
        }

        svcBlock += `</div>`;
        parts.push(svcBlock);
      }

      showDetails(entry, parts.join(""), true);

      if (entry.nus) {
        await setupNusTerminal(entry);
        log("已识别 NUS：终端已就绪（默认不自动订阅 notify）");
      }
    } catch (e) {
      showDetails(entry, `<span class="err">枚举失败：${escapeHtml(e?.message || e)}</span>`, true);
      log("枚举服务失败：" + (e?.message || e));
    }
  }

  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, (c) => ({
      "&": "&amp;",
      "<": "&lt;",
      ">": "&gt;",
      '"': "&quot;",
      "'": "&#39;"
    }[c]));
  }

  btnStart.addEventListener("click", startScan);
  btnStop.addEventListener("click", stopScan);
  btnClear.addEventListener("click", clearTable);

  log("页面已加载。请点击“开始扫描”。");
})();
</script>
</body>
</html>
