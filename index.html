<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>G30 remote log terminal</title>
  <style>
    :root {
      --teal: #0ea3bf;
      --teal-dark: #0b8ea8;
      --bg: #ebedf0;
      --panel: #f8fafb;
      --text: #111;
      --muted: #5e6a73;
    }
    * { box-sizing: border-box; }
    body { font-family: "Segoe UI", "Noto Sans SC", Arial, sans-serif; margin: 0; background: var(--bg); color: var(--text); }
    body > h2 { display: none; }
    .pageTitle { display: block; margin: 0; padding: 8px 16px; background: linear-gradient(180deg, var(--teal-dark), var(--teal)); color: #fff; font-size: 22px; font-weight: 700; letter-spacing: .2px; }
    .panel { background: var(--panel); border-top: 1px solid rgba(0,0,0,.1); padding: 12px; }
    .hint { color: var(--muted); margin: 0 0 10px; line-height: 1.4; font-size: 13px; }
    .controlGrid { display: grid; grid-template-columns: 1fr; gap: 8px; margin-bottom: 10px; }
    .row { margin: 0; }
    .label { font-weight: 600; margin-bottom: 4px; font-size: 13px; color: #23313c; }
    input[type="text"], select { padding: 10px 12px; width: 100%; border: 1px solid #ccd6dd; border-radius: 8px; background: #fff; }
    .actions { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; margin-top: 8px; }
    button { padding: 10px 14px; border: 0; border-radius: 8px; background: #111; color: #fff; font-weight: 700; letter-spacing: .2px; }
    button[disabled] { opacity: .55; }
    .subhint { color: var(--muted); font-size: 12px; line-height: 1.3; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .deviceList { margin-top: 12px; border-top: 1px solid #d4dce2; }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    thead { display: none; }
    td { padding: 0; border: 0; }
    .deviceCard { background: #fff; border-bottom: 1px solid #d4dce2; padding: 12px; }
    .deviceHead { display: flex; justify-content: space-between; align-items: center; gap: 10px; }
    .name { font-size: 24px; font-weight: 600; line-height: 1.1; }
    .meta { color: #54606a; font-size: 13px; font-weight: 700; margin-top: 2px; }
    .metrics { display: flex; gap: 14px; margin-top: 8px; font-size: 13px; align-items: center; }
    .mfgLine { margin-top: 4px; font-size: 13px; font-weight: 700; color: #54606a; }
    .connect { min-width: 132px; }
    .detailsCard { background: #fff; border-bottom: 1px solid #d4dce2; padding: 8px 12px 12px; }
    .notifyOptions { margin: 8px 12px 0; padding: 10px 12px; background: #fff; border: 1px solid #d4dce2; border-radius: 8px; }
    .notifyOptions .label { margin-bottom: 8px; }
    .notifyOptions .opt { display: block; margin: 6px 0; font-size: 14px; color: #23313c; }
    .serverCard { margin: 8px 12px 0; padding: 10px 12px; background: #fff; border: 1px solid #d4dce2; border-radius: 8px; }
    .serverRow { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    .serverLed { width: 12px; height: 12px; border-radius: 50%; background: #9aa4ad; border: 1px solid #7d8791; }
    .serverLed.connecting { background: #d63f3f; border-color: #b82f2f; }
    .serverLed.connected { background: #27a845; border-color: #1f8a38; }
    .sendCard { margin: 8px 12px 0; padding: 10px 12px; background: #fff; border: 1px solid #d4dce2; border-radius: 8px; }
    .sendRow { display: flex; align-items: center; gap: 8px; }
    .sendPrefix { font-weight: 700; color: #23313c; min-width: 24px; text-align: right; }
    .sendInput { flex: 1; }
    #log { white-space: pre-wrap; background: #0b1020; color: #d7e3ff; padding: 10px; border-radius: 8px; margin: 12px; max-height: 640px; overflow-y: auto; }
    .logActions { margin: 0 12px 12px; text-align: center; }
    .btnSmall { padding: 8px 10px; margin: 0; font-size: 12px; border-radius: 8px; }
    .btnSmall[disabled] { opacity: 0.6; }
    details { margin: 0; }
    .svc { margin: 8px 0 10px; }
    .svcTitle { font-weight: 600; }
    .chip { display: inline-block; padding: 2px 6px; border: 1px solid #d0d8de; border-radius: 999px; margin-left: 6px; font-size: 12px; color: #44515b; }
    .err { color: #b00020; }
    .ok  { color: #0a7a2f; }
    @media (max-width: 760px) {
      .name { font-size: 18px; }
      .connect { min-width: 108px; padding: 8px 10px; }
      .metrics { font-size: 13px; }
    }
  </style>
</head>
<body>
  <h2 class="pageTitle">Devices</h2>
  <h2>BLE 扫描（Web Bluetooth）</h2>

  <div class="hint">
    <b>RSSI 扫描：</b>需要 Chrome(安卓) 并通常要在
    <a class="mono" href="chrome://flags/#enable-experimental-web-platform-features" target="_blank" rel="noopener">chrome://flags/#enable-experimental-web-platform-features</a>
    开启实验特性（该地址无法在网页内直接跳转，请复制后粘贴到地址栏）。
    <button id="btnCopyFlags" class="btnSmall" type="button">复制链接</button>
    <span id="copyStatus" class="subhint"></span>
    <br/>
  </div>

  <div class="row">
    <div class="label">可访问服务（optionalServices，逗号分隔）</div>
    <input id="svcInput" type="text" value="6e400001-b5a3-f393-e0a9-e50e24dcca9e" />
  </div>

  <div class="row">
    <div class="label">RSSI 过滤阈值（dBm，仅显示大于该值的设备）</div>
    <input id="rssiInput" type="text" value="-65" />
  </div>

  <div class="actions">
    <button id="btnStart">开始扫描</button>
    <button id="btnStop" disabled>停止扫描</button>
    <button id="btnClear">清空列表</button>
  </div>

  <div class="row" style="margin-top: 14px;">
    <div class="label">数据格式：</div>
    <select id="notifyFormat">
      <option value="hex">Hex</option>
      <option value="text" selected>Text</option>
    </select>
  </div>

  <table>
    <thead>
      <tr>
        <th>名称</th>
        <th>RSSI</th>
        <th>最近一次出现</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <div id="sendCard" class="sendCard" style="display:none;">
    <div class="label">消息发送</div>
    <div class="sendRow">
      <span id="sendPrefix" class="sendPrefix">0x</span>
      <input id="sendInput" class="sendInput" type="text"/>
      <button id="btnSend" type="button">发送</button>
    </div>
  </div>

  <div id="notifyOptions" class="notifyOptions" style="display:none;">
    <div class="label">通知选项</div>
    <label id="optMsgWrap" class="opt" style="display:none;">
      <input id="optNotifyMsg" type="checkbox" checked />
      打开消息通知
    </label>
    <label id="optLogWrap" class="opt" style="display:none;">
      <input id="optNotifyLog" type="checkbox" checked />
      打开日志通知
    </label>
  </div>

  <div id="serverCard" class="serverCard" style="display:none;">
    <div class="label">连接服务器</div>
    <div class="serverRow">
      <span id="serverLed" class="serverLed" aria-hidden="true"></span>
      <button id="btnConnectServer" type="button">连接日志服务器</button>
      <button id="btnDisconnectServer" type="button" disabled>断开连接</button>
    </div>
  </div>

  <div id="log"></div>
  <div class="logActions">
    <button id="btnClearLog" type="button">清空日志</button>
  </div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);
  const tbody = $("tbody");
  const logEl = $("log");
  const btnStart = $("btnStart");
  const btnStop = $("btnStop");
  const btnClear = $("btnClear");
  const notifyFormat = $("notifyFormat");
  const btnCopyFlags = $("btnCopyFlags");
  const copyStatus = $("copyStatus");
  const svcInput = $("svcInput");
  const rssiInput = $("rssiInput");
  const notifyOptions = $("notifyOptions");
  const optMsgWrap = $("optMsgWrap");
  const optLogWrap = $("optLogWrap");
  const optNotifyMsg = $("optNotifyMsg");
  const optNotifyLog = $("optNotifyLog");
  const sendCard = $("sendCard");
  const sendPrefix = $("sendPrefix");
  const sendInput = $("sendInput");
  const btnSend = $("btnSend");
  const btnClearLog = $("btnClearLog");
  const serverCard = $("serverCard");
  const serverLed = $("serverLed");
  const btnConnectServer = $("btnConnectServer");
  const btnDisconnectServer = $("btnDisconnectServer");

  // 只显示最近 10 秒出现过的设备（已连接设备不会被自动剔除）
  const MAX_AGE_MS = 10_000;
  // 刷新 UI 频率（排序 + 过期剔除）
  const REFRESH_MS = 500;

  /** @type {BluetoothLEScan|null} */
  let scan = null;
  /** @type {WebSocket|null} */
  let logWs = null;
  /** @type {number|null} */
  let wsConnectTimer = null;
  /** @type {number|null} */
  let wsReconnectTimer = null;
  let wsReconnectAttempt = 0;
  let wsUserDisabled = false;

  /** @type {number|null} */
  let refreshTimer = null;

  // 用 device.id 做“唯一键”（不显示在表格里）
  const rows = new Map();
  const NUS_SERVICE_UUID = "6e400001-b5a3-f393-e0a9-e50e24dcca9e";
  const NUS_WRITE_UUID = "6e400002-b5a3-f393-e0a9-e50e24dcca9e";
  const NUS_NOTIFY_MSG_UUID = "6e400003-b5a3-f393-e0a9-e50e24dcca9e";
  const NUS_NOTIFY_LOG_UUID = "6e400005-b5a3-f393-e0a9-e50e24dcca9e";
  let activeEntry = null;

  // Web Bluetooth 允许的标准 service name（别名）在不同浏览器实现中可能有差异；
  // 这里给一些常见别名映射到 16-bit UUID，最终统一转成 128-bit 字符串。
  const NAME_TO_16BIT = new Map(Object.entries({
    generic_access: "1800",
    generic_attribute: "1801",
    immediate_alert: "1802",
    link_loss: "1803",
    tx_power: "1804",
    current_time: "1805",
    reference_time_update: "1806",
    next_dst_change: "1807",
    glucose: "1808",
    health_thermometer: "1809",
    device_information: "180A",
    heart_rate: "180D",
    phone_alert_status: "180E",
    battery_service: "180F",
    secure_dfu: "FE59",
    secure_dfu_service: "FE59",
    blood_pressure: "1810",
    alert_notification: "1811",
    human_interface_device: "1812",
    scan_parameters: "1813",
    running_speed_and_cadence: "1814",
    automation_io: "1815",
    cycling_speed_and_cadence: "1816",
    cycling_power: "1818",
    location_and_navigation: "1819",
    environmental_sensing: "181A",
    body_composition: "181B",
    user_data: "181C",
    weight_scale: "181D",
    continuous_glucose_monitoring: "181F"
  }));

  function getRssiThreshold() {
    const v = (rssiInput && rssiInput.value != null) ? String(rssiInput.value).trim() : "";
    const n = Number(v);
    if (!Number.isFinite(n)) return -999; // effectively no filter
    return n;
  }

  function hasName(name) {
    const s = String(name || "").trim();
    return s.length > 0;
  }

  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, (c) => ({
      "&": "&amp;",
      "<": "&lt;",
      ">": "&gt;",
      '"': "&quot;",
      "'": "&#39;"
    }[c]));
  }

  function ansiColorToCss(code) {
    const map = {
      30: "#000000", 31: "#c62828", 32: "#2e7d32", 33: "#f9a825",
      34: "#1565c0", 35: "#ad1457", 36: "#00838f", 37: "#cfd8dc",
      90: "#78909c", 91: "#ef5350", 92: "#66bb6a", 93: "#ffd54f",
      94: "#42a5f5", 95: "#ec407a", 96: "#26c6da", 97: "#ffffff"
    };
    return map[code] || null;
  }

  function ansiToHtml(text) {
    const input = String(text || "");
    const re = /\u001b\[([0-9;]*)m/g;
    let idx = 0;
    let fg = null;
    let out = "";
    let m = null;
    while ((m = re.exec(input)) !== null) {
      const chunk = input.slice(idx, m.index);
      if (chunk) {
        const esc = escapeHtml(chunk);
        out += fg ? `<span style="color:${fg}">${esc}</span>` : esc;
      }
      const codes = (m[1] || "0").split(";").map((v) => Number(v)).filter((v) => Number.isFinite(v));
      if (codes.length === 0) {
        fg = null;
      } else {
        for (const c of codes) {
          if (c === 0 || c === 39) fg = null;
          else {
            const color = ansiColorToCss(c);
            if (color) fg = color;
          }
        }
      }
      idx = re.lastIndex;
    }
    const tail = input.slice(idx);
    if (tail) {
      const esc = escapeHtml(tail);
      out += fg ? `<span style="color:${fg}">${esc}</span>` : esc;
    }
    return out;
  }

  function prependLogLine(content) {
    const lineHtml = ansiToHtml(content);
    logEl.innerHTML = `${lineHtml}<br/>` + logEl.innerHTML;
  }

  function log(msg) {
    const t = new Date().toLocaleString();
    prependLogLine(`[${t}] ${msg}`);
    forwardLogToServer(String(msg));
  }

  function bleLog(content) {
    prependLogLine(content);
    forwardLogToServer(String(content));
  }

  function forwardLogToServer(content) {
    if (!logWs || logWs.readyState !== WebSocket.OPEN) return;
    const cleaned = String(content || "")
      .replace(/\u001b\[[0-9;]*m/g, "") // 去 ANSI 颜色
      .replace(/\r\n/g, "\n")
      .replace(/\r/g, "\n")
      .replace(/\n{2,}/g, "\n") // 合并连续空行
      .replace(/\n+$/g, ""); // 去掉末尾换行
    if (!cleaned) return;
    const payload = {
      ts: Math.floor(Date.now() / 1000), // UTC timestamp (seconds)
      msg: cleaned
    };
    try {
      logWs.send(JSON.stringify(payload));
    } catch (_) {}
  }

  function dataViewToAscii(dataView) {
    if (!dataView) return "";
    const bytes = new Uint8Array(dataView.buffer, dataView.byteOffset, dataView.byteLength);
    return Array.from(bytes).map((b) => String.fromCharCode(b)).join("");
  }

  function parseManufacturerData(dataMap) {
    const list = [];
    if (!dataMap || typeof dataMap.forEach !== "function") return list;
    dataMap.forEach((dataView, companyId) => {
      const companyIdHex = `0x${Number(companyId).toString(16).padStart(4, "0")}`;
      list.push({
        companyId: companyIdHex,
        dataAscii: dataViewToAscii(dataView)
      });
    });
    return list;
  }

  function getEntryManufacturerText(entry) {
    return (entry?.manufacturerData || []).map((item) => item.dataAscii).filter(Boolean).join("");
  }

  function clearWsReconnectTimer() {
    if (wsReconnectTimer !== null) {
      window.clearTimeout(wsReconnectTimer);
      wsReconnectTimer = null;
    }
  }

  function clearWsConnectTimer() {
    if (wsConnectTimer !== null) {
      window.clearTimeout(wsConnectTimer);
      wsConnectTimer = null;
    }
  }

  function canConnectLogServer() {
    if (wsUserDisabled) return false;
    if (!activeEntry?.connected) return false;
    return !!getEntryManufacturerText(activeEntry);
  }

  function scheduleWsReconnect(reason) {
    if (!canConnectLogServer()) return;
    if (logWs && (logWs.readyState === WebSocket.OPEN || logWs.readyState === WebSocket.CONNECTING)) return;
    if (wsReconnectTimer !== null) return;

    const delay = Math.min(1000 * (2 ** wsReconnectAttempt), 15000);
    wsReconnectAttempt = Math.min(wsReconnectAttempt + 1, 6);
    wsReconnectTimer = window.setTimeout(() => {
      wsReconnectTimer = null;
      connectLogServer({ fromAuto: true, silent: true });
    }, delay);
    log(`日志服务器断开，${Math.floor(delay / 1000)} 秒后自动重连（${reason}）`);
  }

  function reconnectLogServerIfNeeded(reason) {
    if (document.visibilityState === "hidden") return;
    if (!canConnectLogServer()) return;
    if (logWs && (logWs.readyState === WebSocket.OPEN || logWs.readyState === WebSocket.CONNECTING)) return;
    clearWsReconnectTimer();
    connectLogServer({ fromAuto: true, silent: true });
    log(`前台恢复，尝试重连日志服务器（${reason}）`);
  }

  function setServerUiState(state) {
    if (!serverLed || !btnConnectServer || !btnDisconnectServer) return;
    serverLed.className = "serverLed";
    if (state === "idle") {
      btnConnectServer.disabled = false;
      btnDisconnectServer.disabled = true;
      return;
    }
    if (state === "connecting") {
      serverLed.classList.add("connecting");
      btnConnectServer.disabled = true;
      btnDisconnectServer.disabled = true;
      return;
    }
    serverLed.classList.add("connected");
    btnConnectServer.disabled = true;
    btnDisconnectServer.disabled = false;
  }

  function disconnectLogServer(options = {}) {
    const { userAction = false } = options;
    if (userAction) wsUserDisabled = true;
    clearWsConnectTimer();
    clearWsReconnectTimer();
    if (logWs) {
      try { logWs.onopen = null; logWs.onclose = null; logWs.onerror = null; } catch (_) {}
      try { logWs.close(); } catch (_) {}
    }
    logWs = null;
    setServerUiState("idle");
  }

  function connectLogServer(options = {}) {
    const { fromAuto = false, silent = false } = options;
    wsUserDisabled = false;

    if (!activeEntry?.connected) {
      if (!silent) log("连接服务器失败：请先连接 BLE 设备");
      return false;
    }

    const manufacturerText = getEntryManufacturerText(activeEntry);
    if (!manufacturerText) {
      if (!silent) log("连接服务器失败：当前设备没有 Manufacturer Data");
      return false;
    }

    if (logWs && logWs.readyState === WebSocket.OPEN) return true;
    if (logWs && logWs.readyState === WebSocket.CONNECTING) return true;

    const url = `wss://ble.wszgdhz.com/ws/log?token=CHANGE_ME_TOKEN&device_id=${encodeURIComponent(manufacturerText)}`;

    disconnectLogServer();
    setServerUiState("connecting");
    if (!silent) log(`正在连接日志服务器：${url}`);

    let ws = null;
    try {
      ws = new WebSocket(url);
    } catch (e) {
      log(`WebSocket 创建失败：${e?.message || e}`);
      setServerUiState("idle");
      if (fromAuto) scheduleWsReconnect("create-failed");
      return false;
    }

    logWs = ws;
    clearWsConnectTimer();
    wsConnectTimer = window.setTimeout(() => {
      if (logWs !== ws) return;
      log("连接超时：请检查服务器是否支持对应协议/端口");
      disconnectLogServer();
      scheduleWsReconnect("timeout");
    }, 10000);

    ws.onopen = () => {
      if (logWs !== ws) return;
      clearWsConnectTimer();
      clearWsReconnectTimer();
      wsReconnectAttempt = 0;
      setServerUiState("connected");
      log("日志服务器已连接");
    };

    ws.onerror = () => {
      if (logWs !== ws) return;
      log("日志服务器连接失败（onerror）");
      disconnectLogServer();
      scheduleWsReconnect("onerror");
    };

    ws.onclose = () => {
      if (logWs !== ws) return;
      clearWsConnectTimer();
      logWs = null;
      setServerUiState("idle");
      log("日志服务器已断开");
      scheduleWsReconnect("closed");
    };
    return true;
  }

  function bindNotifyListener(ch) {
    ch.addEventListener("characteristicvaluechanged", (event) => {
      const dv = event.target.value;
      const bytes = new Uint8Array(dv.buffer, dv.byteOffset, dv.byteLength);
      const mode = notifyFormat?.value === "text" ? "text" : "hex";
      if (mode === "hex") {
        const hex = Array.from(bytes).map((b) => b.toString(16).padStart(2, "0")).join(" ");
        bleLog(hex);
        return;
      }
      let text = "";
      try {
        text = new TextDecoder().decode(bytes);
      } catch (_) {
        text = "";
      }
      bleLog(text);
    });
  }

  function updateNotifyOptionsVisibility(entry) {
    const hasMsg = !!entry?.nusNotifyChars?.get(NUS_NOTIFY_MSG_UUID);
    const hasLog = !!entry?.nusNotifyChars?.get(NUS_NOTIFY_LOG_UUID);
    if (optMsgWrap) optMsgWrap.style.display = hasMsg ? "" : "none";
    if (optLogWrap) optLogWrap.style.display = hasLog ? "" : "none";
    if (notifyOptions) notifyOptions.style.display = (hasMsg || hasLog) ? "" : "none";
  }

  function updateSendCardVisibility(entry) {
    const canSend = !!entry?.connected && !!entry?.nusWriteChar;
    if (sendCard) sendCard.style.display = canSend ? "" : "none";
  }

  function updateServerCardVisibility(entry) {
    const shouldShow = !!entry?.connected;
    if (serverCard) serverCard.style.display = shouldShow ? "" : "none";
    if (!shouldShow) disconnectLogServer();
  }

  function updateDataFormatUI() {
    const isHex = notifyFormat?.value === "hex";
    if (sendPrefix) sendPrefix.style.display = isHex ? "" : "none";
    if (sendInput) sendInput.placeholder = isHex ? "请输入Hex字节流" : "请输入文本";
  }

  function parseHexInputToBytes(hexText) {
    const raw = String(hexText || "").replace(/\s+/g, "");
    if (raw.length === 0) return new Uint8Array();
    if (!/^[0-9a-fA-F]+$/.test(raw)) {
      throw new Error("Hex 输入包含非十六进制字符");
    }
    if (raw.length % 2 !== 0) {
      throw new Error("Hex 输入长度必须为偶数");
    }
    const out = new Uint8Array(raw.length / 2);
    for (let i = 0; i < raw.length; i += 2) {
      out[i / 2] = parseInt(raw.slice(i, i + 2), 16);
    }
    return out;
  }

  async function sendMessage() {
    const entry = activeEntry;
    if (!entry?.connected || !entry?.nusWriteChar) {
      log("发送失败：当前设备未连接或不支持消息发送");
      return;
    }
    const isHex = notifyFormat?.value === "hex";
    const input = sendInput?.value ?? "";
    let bytes = null;
    try {
      bytes = isHex ? parseHexInputToBytes(input) : new TextEncoder().encode(input);
    } catch (e) {
      log(`发送失败：${e?.message || e}`);
      return;
    }

    try {
      const ch = entry.nusWriteChar;
      if (typeof ch.writeValueWithoutResponse === "function") {
        await ch.writeValueWithoutResponse(bytes);
      } else {
        await ch.writeValue(bytes);
      }
      log(`已发送 ${bytes.byteLength} 字节`);
    } catch (e) {
      log(`发送失败：${e?.message || e}`);
    }
  }

  async function setNotifyState(entry, uuid, shouldEnable) {
    const key = uuid.toLowerCase();
    if (!entry.nusNotifyEnabled) entry.nusNotifyEnabled = new Set();
    if (!entry.nusNotifyBound) entry.nusNotifyBound = new Set();
    const ch = entry.nusNotifyChars.get(key);
    if (!ch) return;
    if (shouldEnable) {
      if (entry.nusNotifyEnabled.has(key)) return;
      await ch.startNotifications();
      if (!entry.nusNotifyBound.has(key)) {
        bindNotifyListener(ch);
        entry.nusNotifyBound.add(key);
      }
      entry.nusNotifyEnabled.add(key);
      return;
    }
    if (!entry.nusNotifyEnabled.has(key)) return;
    await ch.stopNotifications();
    entry.nusNotifyEnabled.delete(key);
  }

  async function applySelectedNusNotify(entry) {
    if (!entry?.connected) return;
    await setNotifyState(entry, NUS_NOTIFY_MSG_UUID, !!optNotifyMsg?.checked);
    await setNotifyState(entry, NUS_NOTIFY_LOG_UUID, !!optNotifyLog?.checked);
  }

  function setCopyStatus(msg, ok) {
    if (!copyStatus) return;
    copyStatus.textContent = msg;
    copyStatus.className = ok ? "subhint ok" : "subhint err";
    window.setTimeout(() => {
      if (copyStatus) copyStatus.textContent = "";
      if (copyStatus) copyStatus.className = "subhint";
    }, 2000);
  }

  function ensureRefreshTimer() {
    if (refreshTimer !== null) return;
    refreshTimer = window.setInterval(refreshView, REFRESH_MS);
  }

  function setButtonState(entry, state) {
    const btn = entry.tr?.querySelector("button.connect");
    const badge = entry.tr?.querySelector(".status");
    if (!btn || !badge) return;

    if (state === "idle") {
      btn.disabled = false;
      btn.textContent = "连接";
      badge.textContent = "";
      badge.className = "chip status";
    } else if (state === "connecting") {
      btn.disabled = true;
      btn.textContent = "连接中…";
      badge.textContent = "连接中";
      badge.className = "chip status";
    } else if (state === "connected") {
      btn.disabled = false;
      btn.textContent = "断开";
      badge.textContent = "已连接";
      badge.className = "chip status ok";
    }
  }

  function ensureRows(entry) {
    if (entry.tr) return;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="name"></td>
      <td class="mono rssi"></td>
      <td class="mono last"></td>
      <td>
        <button class="btnSmall connect">连接</button>
        <span class="chip status"></span>
      </td>
    `;

    const detailsTr = document.createElement("tr");
    detailsTr.style.display = "none";
    detailsTr.innerHTML = `
      <td colspan="4">
        <details>
          <summary>服务与特征（Service / Characteristic）</summary>
          <div class="detailBody">(未连接)</div>
        </details>
      </td>
    `;

    entry.tr = tr;
    entry.detailsTr = detailsTr;

    tr.querySelector("button.connect").addEventListener("click", async () => {
      if (entry.connected) {
        await disconnectEntry(entry);
      } else {
        await connectEntry(entry);
      }
    });

    tbody.appendChild(tr);
    tbody.appendChild(detailsTr);
  }

  function upsertRow({ name, id, rssi, advDevice, manufacturerData }) {
    const now = Date.now();
    let entry = rows.get(id);

    if (!entry) {
      entry = {
        tr: null, detailsTr: null,
        lastSeenMs: now,
        rssi: undefined,
        name: "",
        advDevice: null,
        grantedDevice: null,
        gattServer: null,
        connected: false,
        connecting: false,
        manufacturerData: [],
        nusWriteChar: null,
        nusNotifyChars: new Map(),
        nusNotifyEnabled: new Set(),
        nusNotifyBound: new Set()
      };
      rows.set(id, entry);
    }

    ensureRows(entry);

    entry.lastSeenMs = now;
    entry.name = name || "(无名称)";
    if (typeof rssi === "number") entry.rssi = rssi;
    if (advDevice) entry.advDevice = advDevice;
    if (Array.isArray(manufacturerData)) entry.manufacturerData = manufacturerData;

    entry.tr.querySelector(".name").textContent = entry.name;
    entry.tr.querySelector(".rssi").textContent = (typeof entry.rssi === "number") ? `${entry.rssi} dBm` : "(未知)";
    entry.tr.querySelector(".last").textContent = new Date(now).toLocaleTimeString();
    entry.tr.querySelector(".rssi").textContent = (typeof entry.rssi === "number") ? `${entry.rssi} dBm` : "Unknown RSSI";
    entry.tr.querySelector(".last").textContent = `last seen: ${new Date(now).toLocaleTimeString()}`;
    const mfgEl = entry.tr.querySelector(".mfgLine");
    const mfgText = (entry.manufacturerData || []).map((item) => item.dataAscii).filter(Boolean).join("");
    if (mfgEl) {
      if (mfgText) {
        mfgEl.textContent = mfgText;
        mfgEl.style.display = "";
      } else {
        mfgEl.textContent = "";
        mfgEl.style.display = "none";
      }
    }

    refreshView();
  }

  function refreshView() {
    const now = Date.now();

    // 1) 剔除 10 秒未出现过的设备（已连接的不剔除）
    for (const [id, entry] of rows.entries()) {
      if (entry.connected) continue;
      if (now - entry.lastSeenMs > MAX_AGE_MS) {
        entry.tr?.remove();
        entry.detailsTr?.remove();
        rows.delete(id);
      }
    }

    // 2) 按 RSSI 自动排序（RSSI 越大越靠前）
    const entries = Array.from(rows.values());
    entries.sort((a, b) => {
      const ar = (typeof a.rssi === "number") ? a.rssi : -Infinity;
      const br = (typeof b.rssi === "number") ? b.rssi : -Infinity;
      if (br !== ar) return br - ar;
      return b.lastSeenMs - a.lastSeenMs;
    });

    // 3) 重新按顺序挂载
    for (const e of entries) {
      tbody.appendChild(e.tr);
      tbody.appendChild(e.detailsTr);
    }
  }

  function clearTable() {
    for (const entry of rows.values()) {
      try { entry.gattServer?.device?.gatt?.disconnect(); } catch (_) {}
      try { entry.grantedDevice?.gatt?.disconnect(); } catch (_) {}
    }
    rows.clear();
    tbody.innerHTML = "";
    activeEntry = null;
    disconnectLogServer();
    updateServerCardVisibility(null);
    updateNotifyOptionsVisibility(null);
    updateSendCardVisibility(null);
    log("已清空列表（并尝试断开所有连接）");
  }

  function focusOnEntry(keepEntry) {
    for (const [id, entry] of rows.entries()) {
      if (entry === keepEntry) continue;
      entry.tr?.remove();
      entry.detailsTr?.remove();
      rows.delete(id);
    }
    // Ensure the kept entry is visible and at top
    if (keepEntry?.tr) tbody.appendChild(keepEntry.tr);
    if (keepEntry?.detailsTr) tbody.appendChild(keepEntry.detailsTr);
  }

  function normalizeServiceToken(token) {
    // Return: null | { kind: 'name'|'uuid', value: string }
    const t = String(token || "").trim();
    if (!t) return null;

    // 128-bit UUID
    if (/^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/.test(t)) {
      return { kind: "uuid", value: t.toLowerCase() };
    }

    // 0x180A or 180A
    let hex = t.toLowerCase();
    if (hex.startsWith("0x")) hex = hex.slice(2);
    if (/^[0-9a-f]{4}$/.test(hex)) {
      // Convert 16-bit -> 128-bit base UUID
      const full = `0000${hex}-0000-1000-8000-00805f9b34fb`;
      return { kind: "uuid", value: full };
    }

    // name alias
    const key = t.toLowerCase().replace(/\s+/g, "_");
    if (NAME_TO_16BIT.has(key)) {
      const h = NAME_TO_16BIT.get(key).toLowerCase();
      const full = `0000${h}-0000-1000-8000-00805f9b34fb`;
      return { kind: "uuid", value: full };
    }

    // As a fallback, let browser handle standard names if it supports them:
    // (some implementations accept strings like 'battery_service')
    return { kind: "name", value: key };
  }

  function getOptionalServices() {
    const raw = svcInput.value || "";
    const tokens = raw.split(",").map(s => s.trim()).filter(Boolean);
    const normalized = [];
    for (const tok of tokens) {
      const r = normalizeServiceToken(tok);
      if (!r) continue;
      normalized.push(r.value);
    }
    // de-dup
    return Array.from(new Set(normalized));
  }

  async function startScan() {
    if (!("bluetooth" in navigator)) {
      log("当前浏览器不支持 Web Bluetooth（navigator.bluetooth 不存在）");
      return;
    }

    if (typeof navigator.bluetooth.requestLEScan === "function") {
      try {
        scan = await navigator.bluetooth.requestLEScan({ acceptAllAdvertisements: true });
        navigator.bluetooth.addEventListener("advertisementreceived", onAdv);
        btnStart.disabled = true;
        btnStop.disabled = false;
        ensureRefreshTimer();
        log("开始扫描：requestLEScan 已启动（将持续接收周边广播事件）");
        return;
      } catch (e) {
        log("requestLEScan 启动失败：" + (e?.message || e));
        log("将尝试降级到 requestDevice（只能手动选设备，且通常拿不到 RSSI）");
      }
    } else {
      log("当前浏览器没有 requestLEScan（Scanning API 不可用）。尝试降级到 requestDevice。");
    }

    // 降级：requestDevice（不是“被动扫描所有广播”）
    try {
      const device = await navigator.bluetooth.requestDevice({
        acceptAllDevices: true,
        optionalServices: getOptionalServices()
      });
      if (!hasName(device.name)) {
        log("已选择设备但名称为空：按规则不加入列表");
      } else {
        // 该降级路径通常拿不到 RSSI；为严格遵循“RSSI阈值过滤”，这里不加入列表
        log("提示：该浏览器不支持扫描 RSSI（requestDevice 降级路径），无法按 RSSI 阈值过滤；因此不加入列表");
        // 若你希望降级路径也显示设备（RSSI 显示为未知），取消下一行注释：
        // upsertRow({ name: device.name, id: device.id, rssi: undefined, advDevice: device });
      }
      ensureRefreshTimer();
      log(`已选择设备：${device.name || "(无名称)"}`);
    } catch (e) {
      log("requestDevice 失败：" + (e?.message || e));
    }
  }

  function stopScan() {
    try { scan?.stop(); } catch (_) {}
    scan = null;

    navigator.bluetooth.removeEventListener("advertisementreceived", onAdv);
    btnStart.disabled = false;
    btnStop.disabled = true;

    ensureRefreshTimer();
    log("已停止扫描（列表将仅保留最近10秒出现的设备；已连接设备不会自动消失）");
  }

  function onAdv(event) {
    const dev = event.device;

    // 过滤掉“无名称”的设备
    const name = dev?.name;
    if (!hasName(name)) return;

    // RSSI 过滤：只显示大于阈值的设备
    const th = getRssiThreshold();
    const rssi = event.rssi;
    // 你的需求依赖 RSSI：rssi 缺失则不展示
    if (typeof rssi !== "number") return;
    if (rssi <= th) return;

    upsertRow({
      name,
      id: dev?.id || "(unknown-id)",
      rssi,
      advDevice: dev,
      manufacturerData: parseManufacturerData(event.manufacturerData)
    });
  }

  async function connectEntry(entry) {
    if (!("bluetooth" in navigator)) {
      log("当前浏览器不支持 Web Bluetooth。");
      return;
    }
    if (entry.connecting) return;

    entry.connecting = true;
    setButtonState(entry, "connecting");

    try {
      const optionalServices = getOptionalServices();
      if (optionalServices.length === 0) {
        log("提示：optionalServices 为空，连接后无法枚举服务。请在上方输入要访问的服务 UUID/别名。");
      }

      // 点击“连接”时使用 requestDevice() 走一次“用户选择授权”
      let device = null;
      if (entry.name && entry.name !== "(无名称)") {
        device = await navigator.bluetooth.requestDevice({
          filters: [{ name: entry.name }],
          optionalServices
        });
      } else {
        device = await navigator.bluetooth.requestDevice({
          acceptAllDevices: true,
          optionalServices
        });
      }

      entry.grantedDevice = device;

      device.addEventListener("gattserverdisconnected", () => {
        entry.connected = false;
        entry.connecting = false;
        entry.gattServer = null;
        setButtonState(entry, "idle");
        showDetails(entry, "(已断开)", true);
        log(`设备断开：${device.name || "(无名称)"}`);
        if (activeEntry === entry) {
          activeEntry = null;
          disconnectLogServer();
          updateServerCardVisibility(null);
          updateNotifyOptionsVisibility(null);
          updateSendCardVisibility(null);
        }
      });

      const server = await device.gatt.connect();
      entry.gattServer = server;
      entry.connected = true;
      entry.connecting = false;
      setButtonState(entry, "connected");
      log(`已连接：${device.name || "(无名称)"}`);

      // 连接成功后停止扫描，仅保留当前设备
      stopScan();
      focusOnEntry(entry);
      activeEntry = entry;

      updateServerCardVisibility(entry);
      connectLogServer();
      await enumerateGATT(entry, server, optionalServices);
      updateNotifyOptionsVisibility(entry);
      updateSendCardVisibility(entry);
      await applySelectedNusNotify(entry);
    } catch (e) {
      entry.connecting = false;
      entry.connected = false;
      entry.gattServer = null;
      setButtonState(entry, "idle");
      showDetails(entry, `<span class="err">连接/枚举失败：${escapeHtml(e?.message || e)}</span>`, true);
      log("连接/枚举失败：" + (e?.message || e));
    }
  }

  async function disconnectEntry(entry) {
    try {
      const device = entry.grantedDevice || entry.advDevice || entry.gattServer?.device;
      if (device?.gatt?.connected) device.gatt.disconnect();
    } catch (_) {}

    entry.connected = false;
    entry.connecting = false;
    entry.gattServer = null;
    entry.nusWriteChar = null;
    entry.nusNotifyChars = new Map();
    entry.nusNotifyEnabled = new Set();
    entry.nusNotifyBound = new Set();
    setButtonState(entry, "idle");
    showDetails(entry, "(已断开)", true);
    log(`已断开：${entry.grantedDevice?.name || entry.name || "(无名称)"}`);
    if (activeEntry === entry) activeEntry = null;
    disconnectLogServer();
    updateServerCardVisibility(null);
    updateNotifyOptionsVisibility(null);
    updateSendCardVisibility(null);
  }

  function showDetails(entry, html, open) {
    if (!entry.detailsTr) return;
    const details = entry.detailsTr.querySelector("details");
    const body = entry.detailsTr.querySelector(".detailBody");
    if (body) body.innerHTML = html;
    entry.detailsTr.style.display = "";
    if (details && open) details.open = true;
  }

  async function enumerateGATT(entry, server, optionalServices) {
    try {
      // getPrimaryServices() 只会返回“本 origin 被允许访问”的 services
      const services = await server.getPrimaryServices();
      const allowNote = optionalServices?.length
        ? `<div class="subhint">当前允许访问的服务数量：<span class="mono">${optionalServices.length}</span>（只会显示这些范围内能访问到的服务）</div>`
        : `<div class="subhint err">optionalServices 为空：浏览器会拒绝访问任何服务。请在上方输入服务 UUID/别名后再连接。</div>`;

      if (!services || services.length === 0) {
        entry.nusWriteChar = null;
        entry.nusNotifyChars = new Map();
        entry.nusNotifyEnabled = new Set();
        entry.nusNotifyBound = new Set();
        updateNotifyOptionsVisibility(entry);
        updateSendCardVisibility(entry);
        showDetails(entry, `${allowNote}<div>(未发现可访问的 Primary Services)</div>`, false);
        return;
      }

      const parts = [allowNote];
      entry.nusWriteChar = null;
      entry.nusNotifyChars = new Map();
      entry.nusNotifyEnabled = new Set();
      entry.nusNotifyBound = new Set();
      for (const svc of services) {
        let chars = null;
        try {
          chars = await svc.getCharacteristics();
        } catch (e) {
          chars = null;
        }

        const svcUuid = svc.uuid;
        let svcBlock = `<div class="svc"><div class="svcTitle">Service: <span class="mono">${escapeHtml(svcUuid)}</span></div>`;
        if (!chars) {
          svcBlock += `<div class="err">无法读取 Characteristics（可能未将该服务加入 optionalServices 或设备限制）</div>`;
        } else if (chars.length === 0) {
          svcBlock += `<div>(无 Characteristics)</div>`;
        } else {
          svcBlock += `<ul>`;
          for (const ch of chars) {
            const props = [];
            const p = ch.properties;
            if (p.read) props.push("read");
            if (p.write) props.push("write");
            if (p.writeWithoutResponse) props.push("writeWithoutResponse");
            if (p.notify) props.push("notify");
            if (p.indicate) props.push("indicate");
            if (p.authenticatedSignedWrites) props.push("signedWrites");

            const isNusService = (svcUuid.toLowerCase() === NUS_SERVICE_UUID);
            const isNusNotify = isNusService && !!p.notify;
            if (isNusService && ch.uuid.toLowerCase() === NUS_WRITE_UUID) {
              entry.nusWriteChar = ch;
            }
            if (isNusNotify) {
              entry.nusNotifyChars.set(ch.uuid.toLowerCase(), ch);
            }

            svcBlock += `<li>
              <span>Characteristic: <span class="mono">${escapeHtml(ch.uuid)}</span></span>
              <span class="chip">${escapeHtml(props.join(", ") || "no-props")}</span>
            </li>`;
          }
          svcBlock += `</ul>`;
        }
        svcBlock += `</div>`;
        parts.push(svcBlock);
      }

      showDetails(entry, parts.join(""), false);
      updateNotifyOptionsVisibility(entry);
      updateSendCardVisibility(entry);
    } catch (e) {
      showDetails(entry, `<span class="err">枚举失败：${escapeHtml(e?.message || e)}</span>`, false);
      log("枚举服务失败：" + (e?.message || e));
    }
  }

  // Override: scanner-like card UI
  function setButtonState(entry, state) {
    const btn = entry.tr?.querySelector("button.connect");
    const badge = entry.tr?.querySelector(".status");
    if (!btn || !badge) return;
    if (state === "idle") {
      btn.disabled = false;
      btn.textContent = "CONNECT";
      badge.textContent = "";
      badge.className = "chip status";
      return;
    }
    if (state === "connecting") {
      btn.disabled = true;
      btn.textContent = "CONNECTING";
      badge.textContent = "CONNECTING";
      badge.className = "chip status";
      return;
    }
    btn.disabled = false;
    btn.textContent = "DISCONNECT";
    badge.textContent = "CONNECTED";
    badge.className = "chip status ok";
  }

  // Override: render each device as a card-like row
  function ensureRows(entry) {
    if (entry.tr) return;
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td colspan="4">
        <div class="deviceCard">
          <div class="deviceHead">
            <div>
              <div class="name"></div>
              <div class="meta mono last"></div>
              <div class="metrics">
                <span class="mono rssi"></span>
                <span class="chip status"></span>
              </div>
              <div class="mfgLine mono"></div>
            </div>
            <button class="connect">CONNECT</button>
          </div>
        </div>
      </td>
    `;
    const detailsTr = document.createElement("tr");
    detailsTr.style.display = "none";
    detailsTr.innerHTML = `
      <td colspan="4" class="detailsCard">
        <details>
          <summary>Service / Characteristic</summary>
          <div class="detailBody">(未连接)</div>
        </details>
      </td>
    `;
    entry.tr = tr;
    entry.detailsTr = detailsTr;
    tr.querySelector("button.connect").addEventListener("click", async () => {
      if (entry.connected) {
        await disconnectEntry(entry);
      } else {
        await connectEntry(entry);
      }
    });
    tbody.appendChild(tr);
    tbody.appendChild(detailsTr);
  }

  if (btnStart) btnStart.textContent = "START SCAN";
  if (btnStop) btnStop.textContent = "STOP";
  if (btnClear) btnClear.textContent = "CLEAR";
  updateDataFormatUI();
  if (notifyFormat) {
    notifyFormat.addEventListener("change", () => {
      updateDataFormatUI();
    });
  }
  if (optNotifyMsg) {
    optNotifyMsg.addEventListener("change", async () => {
      await applySelectedNusNotify(activeEntry);
    });
  }
  if (optNotifyLog) {
    optNotifyLog.addEventListener("change", async () => {
      await applySelectedNusNotify(activeEntry);
    });
  }
  btnStart.addEventListener("click", startScan);
  btnStop.addEventListener("click", stopScan);
  btnClear.addEventListener("click", clearTable);
  if (btnSend) {
    btnSend.addEventListener("click", async () => {
      await sendMessage();
    });
  }
  if (btnClearLog) {
    btnClearLog.addEventListener("click", () => {
      logEl.innerHTML = "";
    });
  }
  if (btnConnectServer) {
    btnConnectServer.addEventListener("click", () => {
      connectLogServer();
    });
  }
  if (btnDisconnectServer) {
    btnDisconnectServer.addEventListener("click", () => {
      disconnectLogServer({ userAction: true });
      log("日志服务器已断开");
    });
  }
  if (btnCopyFlags) {
    btnCopyFlags.addEventListener("click", async () => {
      const text = "chrome://flags/#enable-experimental-web-platform-features";
      try {
        if (navigator.clipboard && typeof navigator.clipboard.writeText === "function") {
          await navigator.clipboard.writeText(text);
        } else {
          const ta = document.createElement("textarea");
          ta.value = text;
          ta.setAttribute("readonly", "");
          ta.style.position = "absolute";
          ta.style.left = "-9999px";
          document.body.appendChild(ta);
          ta.select();
          document.execCommand("copy");
          ta.remove();
        }
        setCopyStatus("已复制", true);
      } catch (e) {
        setCopyStatus("复制失败，请手动复制", false);
      }
    });
  }
  document.addEventListener("visibilitychange", () => {
    if (document.visibilityState === "visible") reconnectLogServerIfNeeded("visibilitychange");
  });
  window.addEventListener("focus", () => {
    reconnectLogServerIfNeeded("focus");
  });
  window.addEventListener("pageshow", () => {
    reconnectLogServerIfNeeded("pageshow");
  });
  window.addEventListener("online", () => {
    reconnectLogServerIfNeeded("online");
  });

  updateServerCardVisibility(null);
  setServerUiState("idle");
  log("页面已加载。请点击“开始扫描”。");
})();
</script>
</body>
</html>
