<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>G30 remote log terminal</title>
  <style>
    :root {
      --teal: #0ea3bf;
      --teal-dark: #0b8ea8;
      --bg: #ebedf0;
      --panel: #f8fafb;
      --text: #111;
      --muted: #5e6a73;
    }
    * { box-sizing: border-box; }
    body { font-family: "Segoe UI", "Noto Sans SC", Arial, sans-serif; margin: 0; background: var(--bg); color: var(--text); }
    .topBar { display: none; }
    body > h2 { display: none; }
    .pageTitle { display: block; margin: 0; padding: 10px 16px; background: linear-gradient(180deg, var(--teal-dark), var(--teal)); color: #fff; font-size: 24px; font-weight: 700; letter-spacing: .2px; }
    .topMain { display: flex; align-items: center; gap: 12px; padding: 14px 16px; }
    .topMain h2 { margin: 0; font-size: 20px; font-weight: 600; flex: 1; letter-spacing: .2px; }
    .topIcon { width: 32px; text-align: center; font-size: 22px; line-height: 1; }
    .stopAction { border: 0; background: transparent; color: #fff; font-weight: 700; letter-spacing: .4px; padding: 8px 0; }
    .stopAction[disabled] { opacity: .5; }
    .tabs { display: flex; gap: 24px; padding: 0 16px 8px; font-size: 14px; text-transform: uppercase; }
    .tabs span { opacity: .7; border-bottom: 3px solid transparent; padding: 12px 0 10px; }
    .tabs span.active { opacity: 1; border-color: #fff; }
    .panel { background: var(--panel); border-top: 1px solid rgba(0,0,0,.1); padding: 12px; }
    .hint { color: var(--muted); margin: 0 0 10px; line-height: 1.4; font-size: 13px; }
    .controlGrid { display: grid; grid-template-columns: 1fr; gap: 8px; margin-bottom: 10px; }
    .row { margin: 0; }
    .label { font-weight: 600; margin-bottom: 4px; font-size: 13px; color: #23313c; }
    input[type="text"], select { padding: 10px 12px; width: 100%; border: 1px solid #ccd6dd; border-radius: 8px; background: #fff; }
    .actions { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; margin-top: 8px; }
    button { padding: 10px 14px; border: 0; border-radius: 8px; background: #111; color: #fff; font-weight: 700; letter-spacing: .2px; }
    button[disabled] { opacity: .55; }
    .subhint { color: var(--muted); font-size: 12px; line-height: 1.3; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .deviceList { margin-top: 12px; border-top: 1px solid #d4dce2; }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    thead { display: none; }
    td { padding: 0; border: 0; }
    .deviceCard { background: #fff; border-bottom: 1px solid #d4dce2; padding: 12px; }
    .deviceHead { display: flex; justify-content: space-between; align-items: center; gap: 10px; }
    .name { font-size: 24px; font-weight: 600; line-height: 1.1; }
    .meta { color: #6a747e; font-size: 15px; margin-top: 2px; }
    .metrics { display: flex; gap: 14px; margin-top: 8px; font-size: 18px; align-items: center; }
    .connect { min-width: 132px; }
    .detailsCard { background: #fff; border-bottom: 1px solid #d4dce2; padding: 8px 12px 12px; }
    #log { white-space: pre-wrap; background: #0b1020; color: #d7e3ff; padding: 10px; border-radius: 8px; margin: 12px; max-height: 640px; overflow-y: auto; }
    .btnSmall { padding: 8px 10px; margin: 0; font-size: 12px; border-radius: 8px; }
    .btnSmall[disabled] { opacity: 0.6; }
    details { margin: 0; }
    .svc { margin: 8px 0 10px; }
    .svcTitle { font-weight: 600; }
    .chip { display: inline-block; padding: 2px 6px; border: 1px solid #d0d8de; border-radius: 999px; margin-left: 6px; font-size: 12px; color: #44515b; }
    .err { color: #b00020; }
    .ok  { color: #0a7a2f; }
    @media (max-width: 760px) {
      .name { font-size: 18px; }
      .connect { min-width: 108px; padding: 8px 10px; }
      .metrics { font-size: 16px; }
    }
  </style>
</head>
<body>
  <h2 class="pageTitle">Devices</h2>
  <h2>BLE 鎵弿锛圵eb Bluetooth锛?/h2>

  <div class="hint">
    <b>RSSI 鎵弿锛?/b>闇€瑕?Chrome(瀹夊崜) 骞堕€氬父瑕佸湪
    <a class="mono" href="chrome://flags/#enable-experimental-web-platform-features" target="_blank" rel="noopener">chrome://flags/#enable-experimental-web-platform-features</a>
    寮€鍚疄楠岀壒鎬э紙璇ュ湴鍧€鏃犳硶鍦ㄧ綉椤靛唴鐩存帴璺宠浆锛岃澶嶅埗鍚庣矘璐村埌鍦板潃鏍忥級銆?    <button id="btnCopyFlags" class="btnSmall" type="button">澶嶅埗閾炬帴</button>
    <span id="copyStatus" class="subhint"></span>
    <br/>
  </div>

  <div class="row">
    <div class="label">鍙闂湇鍔★紙optionalServices锛岄€楀彿鍒嗛殧锛?/div>
    <input id="svcInput" type="text" value="6e400001-b5a3-f393-e0a9-e50e24dcca9e" />
  </div>

  <div class="row">
    <div class="label">RSSI 杩囨护闃堝€硷紙dBm锛屼粎鏄剧ず澶т簬璇ュ€肩殑璁惧锛?/div>
    <input id="rssiInput" type="text" value="-80" />
  </div>

  <div class="actions">
    <button id="btnStart">寮€濮嬫壂鎻?/button>
    <button id="btnStop" disabled>鍋滄鎵弿</button>
    <button id="btnClear">娓呯┖鍒楄〃</button>
  </div>

  <div class="row">
    <div class="label">Notify输出：</div>
    <select id="notifyFormat" class="btnSmall">
      <option value="hex">Hex</option>
      <option value="text" selected>Text</option>
    </select>
  </div>

  <table>
    <thead>
      <tr>
        <th>鍚嶇О</th>
        <th>RSSI</th>
        <th>鏈€杩戜竴娆″嚭鐜?/th>
        <th>鎿嶄綔</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <div id="log"></div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);
  const tbody = $("tbody");
  const logEl = $("log");
  const btnStart = $("btnStart");
  const btnStop = $("btnStop");
  const btnClear = $("btnClear");
  const notifyFormat = $("notifyFormat");
  const btnCopyFlags = $("btnCopyFlags");
  const copyStatus = $("copyStatus");
  const svcInput = $("svcInput");
  const rssiInput = $("rssiInput");

  // 鍙樉绀烘渶杩?10 绉掑嚭鐜拌繃鐨勮澶囷紙宸茶繛鎺ヨ澶囦笉浼氳鑷姩鍓旈櫎锛?  const MAX_AGE_MS = 10_000;
  // 鍒锋柊 UI 棰戠巼锛堟帓搴?+ 杩囨湡鍓旈櫎锛?  const REFRESH_MS = 500;

  /** @type {BluetoothLEScan|null} */
  let scan = null;

  /** @type {number|null} */
  let refreshTimer = null;

  // 鐢?device.id 鍋氣€滃敮涓€閿€濓紙涓嶆樉绀哄湪琛ㄦ牸閲岋級
  const rows = new Map();
  const NUS_SERVICE_UUID = "6e400001-b5a3-f393-e0a9-e50e24dcca9e";
  const NUS_NOTIFY_UUIDS = [
    "6e400003-b5a3-f393-e0a9-e50e24dcca9e",
    "6e400004-b5a3-f393-e0a9-e50e24dcca9e",
    "6e400005-b5a3-f393-e0a9-e50e24dcca9e"
  ];
  let activeEntry = null;

  // Web Bluetooth 鍏佽鐨勬爣鍑?service name锛堝埆鍚嶏級鍦ㄤ笉鍚屾祻瑙堝櫒瀹炵幇涓彲鑳芥湁宸紓锛?  // 杩欓噷缁欎竴浜涘父瑙佸埆鍚嶆槧灏勫埌 16-bit UUID锛屾渶缁堢粺涓€杞垚 128-bit 瀛楃涓层€?  const NAME_TO_16BIT = new Map(Object.entries({
    generic_access: "1800",
    generic_attribute: "1801",
    immediate_alert: "1802",
    link_loss: "1803",
    tx_power: "1804",
    current_time: "1805",
    reference_time_update: "1806",
    next_dst_change: "1807",
    glucose: "1808",
    health_thermometer: "1809",
    device_information: "180A",
    heart_rate: "180D",
    phone_alert_status: "180E",
    battery_service: "180F",
    secure_dfu: "FE59",
    secure_dfu_service: "FE59",
    blood_pressure: "1810",
    alert_notification: "1811",
    human_interface_device: "1812",
    scan_parameters: "1813",
    running_speed_and_cadence: "1814",
    automation_io: "1815",
    cycling_speed_and_cadence: "1816",
    cycling_power: "1818",
    location_and_navigation: "1819",
    environmental_sensing: "181A",
    body_composition: "181B",
    user_data: "181C",
    weight_scale: "181D",
    continuous_glucose_monitoring: "181F"
  }));

  function getRssiThreshold() {
    const v = (rssiInput && rssiInput.value != null) ? String(rssiInput.value).trim() : "";
    const n = Number(v);
    if (!Number.isFinite(n)) return -999; // effectively no filter
    return n;
  }

  function hasName(name) {
    const s = String(name || "").trim();
    return s.length > 0;
  }

  function log(msg) {
    const t = new Date().toLocaleString();
    logEl.textContent = `[${t}] ${msg}\n` + logEl.textContent;
  }

  function bleLog(content) {
    logEl.textContent = `${content}\n` + logEl.textContent;
  }

  function bindNotifyListener(ch) {
    ch.addEventListener("characteristicvaluechanged", (event) => {
      const dv = event.target.value;
      const bytes = new Uint8Array(dv.buffer, dv.byteOffset, dv.byteLength);
      const mode = notifyFormat?.value === "text" ? "text" : "hex";
      if (mode === "hex") {
        const hex = Array.from(bytes).map((b) => b.toString(16).padStart(2, "0")).join(" ");
        bleLog(hex);
        return;
      }
      let text = "";
      try {
        text = new TextDecoder().decode(bytes);
      } catch (_) {
        text = "";
      }
      bleLog(text);
    });
  }

  async function enableAutoNusNotify(entry) {
    if (!entry?.connected) return;

    let enabledCount = 0;
    let foundAny = false;
    for (const uuid of NUS_NOTIFY_UUIDS) {
      const key = uuid.toLowerCase();
      const ch = entry.nusNotifyChars.get(key);
      if (!ch) continue;
      foundAny = true;
      if (entry.nusNotifyEnabled.has(key)) continue;
      try {
        await ch.startNotifications();
        bindNotifyListener(ch);
        entry.nusNotifyEnabled.add(key);
        enabledCount += 1;
      } catch (e) {
        log(`鑷姩鍚敤 Notify 澶辫触锛?{uuid} - ${e?.message || e}`);
      }
    }

    if (!foundAny) {
      log("鏈彂鐜?NUS 鐩爣 Notify Characteristic");
      return;
    }
    if (enabledCount > 0) {
      log(`宸茶嚜鍔ㄥ惎鐢?NUS Notify锛?{enabledCount} 涓猔);
    } else {
      log("NUS Notify 宸叉槸鍚敤鐘舵€?);
    }
  }

  function setCopyStatus(msg, ok) {
    if (!copyStatus) return;
    copyStatus.textContent = msg;
    copyStatus.className = ok ? "subhint ok" : "subhint err";
    window.setTimeout(() => {
      if (copyStatus) copyStatus.textContent = "";
      if (copyStatus) copyStatus.className = "subhint";
    }, 2000);
  }

  function ensureRefreshTimer() {
    if (refreshTimer !== null) return;
    refreshTimer = window.setInterval(refreshView, REFRESH_MS);
  }

  function setButtonState(entry, state) {
    const btn = entry.tr?.querySelector("button.connect");
    const badge = entry.tr?.querySelector(".status");
    if (!btn || !badge) return;

    if (state === "idle") {
      btn.disabled = false;
      btn.textContent = "杩炴帴";
      badge.textContent = "";
      badge.className = "chip status";
    } else if (state === "connecting") {
      btn.disabled = true;
      btn.textContent = "杩炴帴涓€?;
      badge.textContent = "杩炴帴涓?;
      badge.className = "chip status";
    } else if (state === "connected") {
      btn.disabled = false;
      btn.textContent = "鏂紑";
      badge.textContent = "宸茶繛鎺?;
      badge.className = "chip status ok";
    }
  }

  function ensureRows(entry) {
    if (entry.tr) return;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="name"></td>
      <td class="mono rssi"></td>
      <td class="mono last"></td>
      <td>
        <button class="btnSmall connect">杩炴帴</button>
        <span class="chip status"></span>
      </td>
    `;

    const detailsTr = document.createElement("tr");
    detailsTr.style.display = "none";
    detailsTr.innerHTML = `
      <td colspan="4">
        <details open>
          <summary>鏈嶅姟涓庣壒寰侊紙Service / Characteristic锛?/summary>
          <div class="detailBody">(鏈繛鎺?</div>
        </details>
      </td>
    `;

    entry.tr = tr;
    entry.detailsTr = detailsTr;

    tr.querySelector("button.connect").addEventListener("click", async () => {
      if (entry.connected) {
        await disconnectEntry(entry);
      } else {
        await connectEntry(entry);
      }
    });

    tbody.appendChild(tr);
    tbody.appendChild(detailsTr);
  }

  function upsertRow({ name, id, rssi, advDevice }) {
    const now = Date.now();
    let entry = rows.get(id);

    if (!entry) {
      entry = {
        tr: null, detailsTr: null,
        lastSeenMs: now,
        rssi: undefined,
        name: "",
        advDevice: null,
        grantedDevice: null,
        gattServer: null,
        connected: false,
        connecting: false,
        nusNotifyChars: new Map(),
        nusNotifyEnabled: new Set()
      };
      rows.set(id, entry);
    }

    ensureRows(entry);

    entry.lastSeenMs = now;
    entry.name = name || "(鏃犲悕绉?";
    if (typeof rssi === "number") entry.rssi = rssi;
    if (advDevice) entry.advDevice = advDevice;

    entry.tr.querySelector(".name").textContent = entry.name;
    entry.tr.querySelector(".rssi").textContent = (typeof entry.rssi === "number") ? `${entry.rssi} dBm` : "(鏈煡)";
    entry.tr.querySelector(".last").textContent = new Date(now).toLocaleTimeString();
    entry.tr.querySelector(".rssi").textContent = (typeof entry.rssi === "number") ? `${entry.rssi} dBm` : "Unknown RSSI";
    entry.tr.querySelector(".last").textContent = `last seen: ${new Date(now).toLocaleTimeString()}`;

    refreshView();
  }

  function refreshView() {
    const now = Date.now();

    // 1) 鍓旈櫎 10 绉掓湭鍑虹幇杩囩殑璁惧锛堝凡杩炴帴鐨勪笉鍓旈櫎锛?    for (const [id, entry] of rows.entries()) {
      if (entry.connected) continue;
      if (now - entry.lastSeenMs > MAX_AGE_MS) {
        entry.tr?.remove();
        entry.detailsTr?.remove();
        rows.delete(id);
      }
    }

    // 2) 鎸?RSSI 鑷姩鎺掑簭锛圧SSI 瓒婂ぇ瓒婇潬鍓嶏級
    const entries = Array.from(rows.values());
    entries.sort((a, b) => {
      const ar = (typeof a.rssi === "number") ? a.rssi : -Infinity;
      const br = (typeof b.rssi === "number") ? b.rssi : -Infinity;
      if (br !== ar) return br - ar;
      return b.lastSeenMs - a.lastSeenMs;
    });

    // 3) 閲嶆柊鎸夐『搴忔寕杞?    for (const e of entries) {
      tbody.appendChild(e.tr);
      tbody.appendChild(e.detailsTr);
    }
  }

  function clearTable() {
    for (const entry of rows.values()) {
      try { entry.gattServer?.device?.gatt?.disconnect(); } catch (_) {}
      try { entry.grantedDevice?.gatt?.disconnect(); } catch (_) {}
    }
    rows.clear();
    tbody.innerHTML = "";
    log("宸叉竻绌哄垪琛紙骞跺皾璇曟柇寮€鎵€鏈夎繛鎺ワ級");
  }

  function focusOnEntry(keepEntry) {
    for (const [id, entry] of rows.entries()) {
      if (entry === keepEntry) continue;
      entry.tr?.remove();
      entry.detailsTr?.remove();
      rows.delete(id);
    }
    // Ensure the kept entry is visible and at top
    if (keepEntry?.tr) tbody.appendChild(keepEntry.tr);
    if (keepEntry?.detailsTr) tbody.appendChild(keepEntry.detailsTr);
  }

  function normalizeServiceToken(token) {
    // Return: null | { kind: 'name'|'uuid', value: string }
    const t = String(token || "").trim();
    if (!t) return null;

    // 128-bit UUID
    if (/^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/.test(t)) {
      return { kind: "uuid", value: t.toLowerCase() };
    }

    // 0x180A or 180A
    let hex = t.toLowerCase();
    if (hex.startsWith("0x")) hex = hex.slice(2);
    if (/^[0-9a-f]{4}$/.test(hex)) {
      // Convert 16-bit -> 128-bit base UUID
      const full = `0000${hex}-0000-1000-8000-00805f9b34fb`;
      return { kind: "uuid", value: full };
    }

    // name alias
    const key = t.toLowerCase().replace(/\s+/g, "_");
    if (NAME_TO_16BIT.has(key)) {
      const h = NAME_TO_16BIT.get(key).toLowerCase();
      const full = `0000${h}-0000-1000-8000-00805f9b34fb`;
      return { kind: "uuid", value: full };
    }

    // As a fallback, let browser handle standard names if it supports them:
    // (some implementations accept strings like 'battery_service')
    return { kind: "name", value: key };
  }

  function getOptionalServices() {
    const raw = svcInput.value || "";
    const tokens = raw.split(",").map(s => s.trim()).filter(Boolean);
    const normalized = [];
    for (const tok of tokens) {
      const r = normalizeServiceToken(tok);
      if (!r) continue;
      normalized.push(r.value);
    }
    // de-dup
    return Array.from(new Set(normalized));
  }

  async function startScan() {
    if (!("bluetooth" in navigator)) {
      log("褰撳墠娴忚鍣ㄤ笉鏀寔 Web Bluetooth锛坣avigator.bluetooth 涓嶅瓨鍦級");
      return;
    }

    if (typeof navigator.bluetooth.requestLEScan === "function") {
      try {
        scan = await navigator.bluetooth.requestLEScan({ acceptAllAdvertisements: true });
        navigator.bluetooth.addEventListener("advertisementreceived", onAdv);
        btnStart.disabled = true;
        btnStop.disabled = false;
        ensureRefreshTimer();
        log("寮€濮嬫壂鎻忥細requestLEScan 宸插惎鍔紙灏嗘寔缁帴鏀跺懆杈瑰箍鎾簨浠讹級");
        return;
      } catch (e) {
        log("requestLEScan 鍚姩澶辫触锛? + (e?.message || e));
        log("灏嗗皾璇曢檷绾у埌 requestDevice锛堝彧鑳芥墜鍔ㄩ€夎澶囷紝涓旈€氬父鎷夸笉鍒?RSSI锛?);
      }
    } else {
      log("褰撳墠娴忚鍣ㄦ病鏈?requestLEScan锛圫canning API 涓嶅彲鐢級銆傚皾璇曢檷绾у埌 requestDevice銆?);
    }

    // 闄嶇骇锛歳equestDevice锛堜笉鏄€滆鍔ㄦ壂鎻忔墍鏈夊箍鎾€濓級
    try {
      const device = await navigator.bluetooth.requestDevice({
        acceptAllDevices: true,
        optionalServices: getOptionalServices()
      });
      if (!hasName(device.name)) {
        log("宸查€夋嫨璁惧浣嗗悕绉颁负绌猴細鎸夎鍒欎笉鍔犲叆鍒楄〃");
      } else {
        // 璇ラ檷绾ц矾寰勯€氬父鎷夸笉鍒?RSSI锛涗负涓ユ牸閬靛惊鈥淩SSI闃堝€艰繃婊も€濓紝杩欓噷涓嶅姞鍏ュ垪琛?        log("鎻愮ず锛氳娴忚鍣ㄤ笉鏀寔鎵弿 RSSI锛坮equestDevice 闄嶇骇璺緞锛夛紝鏃犳硶鎸?RSSI 闃堝€艰繃婊わ紱鍥犳涓嶅姞鍏ュ垪琛?);
        // 鑻ヤ綘甯屾湜闄嶇骇璺緞涔熸樉绀鸿澶囷紙RSSI 鏄剧ず涓烘湭鐭ワ級锛屽彇娑堜笅涓€琛屾敞閲婏細
        // upsertRow({ name: device.name, id: device.id, rssi: undefined, advDevice: device });
      }
      ensureRefreshTimer();
      log(`宸查€夋嫨璁惧锛?{device.name || "(鏃犲悕绉?"}`);
    } catch (e) {
      log("requestDevice 澶辫触锛? + (e?.message || e));
    }
  }

  function stopScan() {
    try { scan?.stop(); } catch (_) {}
    scan = null;

    navigator.bluetooth.removeEventListener("advertisementreceived", onAdv);
    btnStart.disabled = false;
    btnStop.disabled = true;

    ensureRefreshTimer();
    log("宸插仠姝㈡壂鎻忥紙鍒楄〃灏嗕粎淇濈暀鏈€杩?0绉掑嚭鐜扮殑璁惧锛涘凡杩炴帴璁惧涓嶄細鑷姩娑堝け锛?);
  }

  function onAdv(event) {
    const dev = event.device;

    // 杩囨护鎺夆€滄棤鍚嶇О鈥濈殑璁惧
    const name = dev?.name;
    if (!hasName(name)) return;

    // RSSI 杩囨护锛氬彧鏄剧ず澶т簬闃堝€肩殑璁惧
    const th = getRssiThreshold();
    const rssi = event.rssi;
    // 浣犵殑闇€姹備緷璧?RSSI锛歳ssi 缂哄け鍒欎笉灞曠ず
    if (typeof rssi !== "number") return;
    if (rssi <= th) return;

    upsertRow({
      name,
      id: dev?.id || "(unknown-id)",
      rssi,
      advDevice: dev
    });
  }

  async function connectEntry(entry) {
    if (!("bluetooth" in navigator)) {
      log("褰撳墠娴忚鍣ㄤ笉鏀寔 Web Bluetooth銆?);
      return;
    }
    if (entry.connecting) return;

    entry.connecting = true;
    setButtonState(entry, "connecting");

    try {
      const optionalServices = getOptionalServices();
      if (optionalServices.length === 0) {
        log("鎻愮ず锛歰ptionalServices 涓虹┖锛岃繛鎺ュ悗鏃犳硶鏋氫妇鏈嶅姟銆傝鍦ㄤ笂鏂硅緭鍏ヨ璁块棶鐨勬湇鍔?UUID/鍒悕銆?);
      }

      // 鐐瑰嚮鈥滆繛鎺モ€濇椂浣跨敤 requestDevice() 璧颁竴娆♀€滅敤鎴烽€夋嫨鎺堟潈鈥?      let device = null;
      if (entry.name && entry.name !== "(鏃犲悕绉?") {
        device = await navigator.bluetooth.requestDevice({
          filters: [{ name: entry.name }],
          optionalServices
        });
      } else {
        device = await navigator.bluetooth.requestDevice({
          acceptAllDevices: true,
          optionalServices
        });
      }

      entry.grantedDevice = device;

      device.addEventListener("gattserverdisconnected", () => {
        entry.connected = false;
        entry.connecting = false;
        entry.gattServer = null;
        setButtonState(entry, "idle");
        showDetails(entry, "(宸叉柇寮€)", true);
        log(`璁惧鏂紑锛?{device.name || "(鏃犲悕绉?"}`);
      });

      const server = await device.gatt.connect();
      entry.gattServer = server;
      entry.connected = true;
      entry.connecting = false;
      setButtonState(entry, "connected");
      log(`宸茶繛鎺ワ細${device.name || "(鏃犲悕绉?"}`);

      // 杩炴帴鎴愬姛鍚庡仠姝㈡壂鎻忥紝浠呬繚鐣欏綋鍓嶈澶?      stopScan();
      focusOnEntry(entry);
      activeEntry = entry;

      await enumerateGATT(entry, server, optionalServices);
      await enableAutoNusNotify(entry);
    } catch (e) {
      entry.connecting = false;
      entry.connected = false;
      entry.gattServer = null;
      setButtonState(entry, "idle");
      showDetails(entry, `<span class="err">杩炴帴/鏋氫妇澶辫触锛?{escapeHtml(e?.message || e)}</span>`, true);
      log("杩炴帴/鏋氫妇澶辫触锛? + (e?.message || e));
    }
  }

  async function disconnectEntry(entry) {
    try {
      const device = entry.grantedDevice || entry.advDevice || entry.gattServer?.device;
      if (device?.gatt?.connected) device.gatt.disconnect();
    } catch (_) {}

    entry.connected = false;
    entry.connecting = false;
    entry.gattServer = null;
    entry.nusNotifyChars = new Map();
    entry.nusNotifyEnabled = new Set();
    setButtonState(entry, "idle");
    showDetails(entry, "(宸叉柇寮€)", true);
    log(`宸叉柇寮€锛?{entry.grantedDevice?.name || entry.name || "(鏃犲悕绉?"}`);
    if (activeEntry === entry) activeEntry = null;
  }

  function showDetails(entry, html, open) {
    if (!entry.detailsTr) return;
    const details = entry.detailsTr.querySelector("details");
    const body = entry.detailsTr.querySelector(".detailBody");
    if (body) body.innerHTML = html;
    entry.detailsTr.style.display = "";
    if (details && open) details.open = true;
  }

  async function enumerateGATT(entry, server, optionalServices) {
    try {
      // getPrimaryServices() 鍙細杩斿洖鈥滄湰 origin 琚厑璁歌闂€濈殑 services
      const services = await server.getPrimaryServices();
      const allowNote = optionalServices?.length
        ? `<div class="subhint">褰撳墠鍏佽璁块棶鐨勬湇鍔℃暟閲忥細<span class="mono">${optionalServices.length}</span>锛堝彧浼氭樉绀鸿繖浜涜寖鍥村唴鑳借闂埌鐨勬湇鍔★級</div>`
        : `<div class="subhint err">optionalServices 涓虹┖锛氭祻瑙堝櫒浼氭嫆缁濊闂换浣曟湇鍔°€傝鍦ㄤ笂鏂硅緭鍏ユ湇鍔?UUID/鍒悕鍚庡啀杩炴帴銆?/div>`;

      if (!services || services.length === 0) {
        showDetails(entry, `${allowNote}<div>(鏈彂鐜板彲璁块棶鐨?Primary Services)</div>`, true);
        return;
      }

      const parts = [allowNote];
      entry.nusNotifyChars = new Map();
      entry.nusNotifyEnabled = new Set();
      for (const svc of services) {
        let chars = null;
        try {
          chars = await svc.getCharacteristics();
        } catch (e) {
          chars = null;
        }

        const svcUuid = svc.uuid;
        let svcBlock = `<div class="svc"><div class="svcTitle">Service: <span class="mono">${escapeHtml(svcUuid)}</span></div>`;
        if (!chars) {
          svcBlock += `<div class="err">鏃犳硶璇诲彇 Characteristics锛堝彲鑳芥湭灏嗚鏈嶅姟鍔犲叆 optionalServices 鎴栬澶囬檺鍒讹級</div>`;
        } else if (chars.length === 0) {
          svcBlock += `<div>(鏃?Characteristics)</div>`;
        } else {
          svcBlock += `<ul>`;
          for (const ch of chars) {
            const props = [];
            const p = ch.properties;
            if (p.read) props.push("read");
            if (p.write) props.push("write");
            if (p.writeWithoutResponse) props.push("writeWithoutResponse");
            if (p.notify) props.push("notify");
            if (p.indicate) props.push("indicate");
            if (p.authenticatedSignedWrites) props.push("signedWrites");

            const isNusNotify = (svcUuid.toLowerCase() === NUS_SERVICE_UUID) && !!p.notify;
            if (isNusNotify) {
              entry.nusNotifyChars.set(ch.uuid.toLowerCase(), ch);
            }

            svcBlock += `<li>
              <span>Characteristic: <span class="mono">${escapeHtml(ch.uuid)}</span></span>
              <span class="chip">${escapeHtml(props.join(", ") || "no-props")}</span>
            </li>`;
          }
          svcBlock += `</ul>`;
        }
        svcBlock += `</div>`;
        parts.push(svcBlock);
      }

      showDetails(entry, parts.join(""), true);
    } catch (e) {
      showDetails(entry, `<span class="err">鏋氫妇澶辫触锛?{escapeHtml(e?.message || e)}</span>`, true);
      log("鏋氫妇鏈嶅姟澶辫触锛? + (e?.message || e));
    }
  }

  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, (c) => ({
      "&": "&amp;",
      "<": "&lt;",
      ">": "&gt;",
      '"': "&quot;",
      "'": "&#39;"
    }[c]));
  }

  // Override: scanner-like card UI
  function setButtonState(entry, state) {
    const btn = entry.tr?.querySelector("button.connect");
    const badge = entry.tr?.querySelector(".status");
    if (!btn || !badge) return;
    if (state === "idle") {
      btn.disabled = false;
      btn.textContent = "CONNECT";
      badge.textContent = "";
      badge.className = "chip status";
      return;
    }
    if (state === "connecting") {
      btn.disabled = true;
      btn.textContent = "CONNECTING";
      badge.textContent = "CONNECTING";
      badge.className = "chip status";
      return;
    }
    btn.disabled = false;
    btn.textContent = "DISCONNECT";
    badge.textContent = "CONNECTED";
    badge.className = "chip status ok";
  }

  // Override: render each device as a card-like row
  function ensureRows(entry) {
    if (entry.tr) return;
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td colspan="4">
        <div class="deviceCard">
          <div class="deviceHead">
            <div>
              <div class="name"></div>
              <div class="meta mono last"></div>
              <div class="metrics">
                <span class="mono rssi"></span>
                <span class="chip status"></span>
              </div>
            </div>
            <button class="connect">CONNECT</button>
          </div>
        </div>
      </td>
    `;
    const detailsTr = document.createElement("tr");
    detailsTr.style.display = "none";
    detailsTr.innerHTML = `
      <td colspan="4" class="detailsCard">
        <details open>
          <summary>Service / Characteristic</summary>
          <div class="detailBody">(鏈繛鎺?</div>
        </details>
      </td>
    `;
    entry.tr = tr;
    entry.detailsTr = detailsTr;
    tr.querySelector("button.connect").addEventListener("click", async () => {
      if (entry.connected) {
        await disconnectEntry(entry);
      } else {
        await connectEntry(entry);
      }
    });
    tbody.appendChild(tr);
    tbody.appendChild(detailsTr);
  }

  if (btnStart) btnStart.textContent = "START SCANNING";
  if (btnStop) btnStop.textContent = "STOP SCANNING";
  if (btnClear) btnClear.textContent = "CLEAR";
  btnStart.addEventListener("click", startScan);
  btnStop.addEventListener("click", stopScan);
  btnClear.addEventListener("click", clearTable);
  if (btnCopyFlags) {
    btnCopyFlags.addEventListener("click", async () => {
      const text = "chrome://flags/#enable-experimental-web-platform-features";
      try {
        if (navigator.clipboard && typeof navigator.clipboard.writeText === "function") {
          await navigator.clipboard.writeText(text);
        } else {
          const ta = document.createElement("textarea");
          ta.value = text;
          ta.setAttribute("readonly", "");
          ta.style.position = "absolute";
          ta.style.left = "-9999px";
          document.body.appendChild(ta);
          ta.select();
          document.execCommand("copy");
          ta.remove();
        }
        setCopyStatus("宸插鍒?, true);
      } catch (e) {
        setCopyStatus("澶嶅埗澶辫触锛岃鎵嬪姩澶嶅埗", false);
      }
    });
  }

  log("椤甸潰宸插姞杞姐€傝鐐瑰嚮鈥滃紑濮嬫壂鎻忊€濄€?);
})();
</script>
</body>
</html>

