<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BLE 扫描（Web Bluetooth）示例</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 16px; }
    button { padding: 10px 14px; margin-right: 8px; }
    .hint { color: #666; margin: 10px 0 14px; line-height: 1.5; }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    th, td { border: 1px solid #ddd; padding: 8px; font-size: 14px; vertical-align: top; }
    th { background: #f6f6f6; text-align: left; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    #log { white-space: pre-wrap; background: #0b1020; color: #d7e3ff; padding: 10px; border-radius: 8px; margin-top: 12px; }
    .btnSmall { padding: 6px 10px; margin: 0; }
    .btnSmall[disabled] { opacity: 0.6; }
    details { margin: 8px 0; }
    .svc { margin: 8px 0 10px; }
    .svcTitle { font-weight: 600; }
    .chip { display: inline-block; padding: 2px 6px; border: 1px solid #ddd; border-radius: 999px; margin-left: 6px; font-size: 12px; color: #444; }
    .err { color: #b00020; }
  </style>
</head>
<body>
  <h2>BLE 扫描（Web Bluetooth）</h2>

  <div class="hint">
    <b>提示：</b>网页拿不到 BLE 的真实 MAC 地址（隐私限制）。<br/>
    <b>RSSI 扫描：</b>需要 Chrome(安卓) 并通常要在 <span class="mono">chrome://flags/#enable-experimental-web-platform-features</span> 开启实验特性。<br/>
    <b>环境：</b>必须 HTTPS 或 localhost。<br/>
    <b>连接说明：</b>部分浏览器会要求通过 <span class="mono">requestDevice()</span> 授权后才能真正连接；本页面点击“连接”会尽量用名称过滤打开设备选择器（若名称为空则无法过滤）。
  </div>

  <div>
    <button id="btnStart">开始扫描</button>
    <button id="btnStop" disabled>停止扫描</button>
    <button id="btnClear">清空列表</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>名称</th>
        <th>RSSI</th>
        <th>最近一次出现</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <div id="log"></div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);
  const tbody = $("tbody");
  const logEl = $("log");
  const btnStart = $("btnStart");
  const btnStop = $("btnStop");
  const btnClear = $("btnClear");

  // 只显示最近 10 秒出现过的设备（已连接设备不会被自动剔除）
  const MAX_AGE_MS = 10_000;
  // 刷新 UI 频率（排序 + 过期剔除）
  const REFRESH_MS = 500;

  /** @type {BluetoothLEScan|null} */
  let scan = null;

  /** @type {number|null} */
  let refreshTimer = null;

  // 用 device.id 做“唯一键”（不显示在表格里）
  // id => {
  //   tr, detailsTr, lastSeenMs, rssi, name,
  //   advDevice, grantedDevice, gattServer,
  //   connected, connecting
  // }
  const rows = new Map();

  function log(msg) {
    const t = new Date().toLocaleString();
    logEl.textContent = `[${t}] ${msg}\n` + logEl.textContent;
  }

  function ensureRefreshTimer() {
    if (refreshTimer !== null) return;
    refreshTimer = window.setInterval(refreshView, REFRESH_MS);
  }

  function stopRefreshTimer() {
    if (refreshTimer === null) return;
    window.clearInterval(refreshTimer);
    refreshTimer = null;
  }

  function setButtonState(entry, state) {
    // state: 'idle' | 'connecting' | 'connected'
    const btn = entry.tr?.querySelector("button.connect");
    const badge = entry.tr?.querySelector(".status");
    if (!btn || !badge) return;

    if (state === "idle") {
      btn.disabled = false;
      btn.textContent = "连接";
      badge.textContent = "";
    } else if (state === "connecting") {
      btn.disabled = true;
      btn.textContent = "连接中…";
      badge.textContent = "连接中";
    } else if (state === "connected") {
      btn.disabled = false;
      btn.textContent = "断开";
      badge.textContent = "已连接";
    }
  }

  function ensureRows(entry) {
    if (entry.tr) return;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="name"></td>
      <td class="mono rssi"></td>
      <td class="mono last"></td>
      <td>
        <button class="btnSmall connect">连接</button>
        <span class="chip status"></span>
      </td>
    `;

    const detailsTr = document.createElement("tr");
    detailsTr.style.display = "none";
    detailsTr.innerHTML = `
      <td colspan="4">
        <details open>
          <summary>服务与特征（Service / Characteristic）</summary>
          <div class="detailBody">(未连接)</div>
        </details>
      </td>
    `;

    entry.tr = tr;
    entry.detailsTr = detailsTr;

    tr.querySelector("button.connect").addEventListener("click", async () => {
      if (entry.connected) {
        await disconnectEntry(entry);
      } else {
        await connectEntry(entry);
      }
    });

    tbody.appendChild(tr);
    tbody.appendChild(detailsTr);
  }

  function upsertRow({ name, id, rssi, advDevice }) {
    const now = Date.now();
    let entry = rows.get(id);

    if (!entry) {
      entry = {
        tr: null, detailsTr: null,
        lastSeenMs: now,
        rssi: undefined,
        name: "",
        advDevice: null,
        grantedDevice: null,
        gattServer: null,
        connected: false,
        connecting: false
      };
      rows.set(id, entry);
    }

    ensureRows(entry);

    entry.lastSeenMs = now;
    entry.name = name || "(无名称)";
    // RSSI 可能偶尔缺失：保留最近一次数值
    if (typeof rssi === "number") entry.rssi = rssi;
    if (advDevice) entry.advDevice = advDevice;

    entry.tr.querySelector(".name").textContent = entry.name;
    entry.tr.querySelector(".rssi").textContent = (typeof entry.rssi === "number") ? `${entry.rssi} dBm` : "(未知)";
    entry.tr.querySelector(".last").textContent = new Date(now).toLocaleTimeString();

    refreshView();
  }

  function refreshView() {
    const now = Date.now();

    // 1) 剔除 10 秒未出现过的设备（已连接的不剔除）
    for (const [id, entry] of rows.entries()) {
      if (entry.connected) continue;
      if (now - entry.lastSeenMs > MAX_AGE_MS) {
        entry.tr?.remove();
        entry.detailsTr?.remove();
        rows.delete(id);
      }
    }

    // 2) 按 RSSI 自动排序（RSSI 越大越靠前，例如 -35 > -80）
    const entries = Array.from(rows.values());
    entries.sort((a, b) => {
      const ar = (typeof a.rssi === "number") ? a.rssi : -Infinity;
      const br = (typeof b.rssi === "number") ? b.rssi : -Infinity;
      if (br !== ar) return br - ar;
      return b.lastSeenMs - a.lastSeenMs;
    });

    // 3) 重新按顺序挂载（appendChild 会移动已存在节点）
    for (const e of entries) {
      tbody.appendChild(e.tr);
      tbody.appendChild(e.detailsTr);
    }
  }

  function clearTable() {
    for (const entry of rows.values()) {
      try { entry.gattServer?.device?.gatt?.disconnect(); } catch (_) {}
      try { entry.grantedDevice?.gatt?.disconnect(); } catch (_) {}
    }
    rows.clear();
    tbody.innerHTML = "";
    log("已清空列表（并尝试断开所有连接）");
  }

  async function startScan() {
    if (!("bluetooth" in navigator)) {
      log("当前浏览器不支持 Web Bluetooth（navigator.bluetooth 不存在）");
      return;
    }

    // 优先使用 Scanning API（能拿 RSSI）
    if (typeof navigator.bluetooth.requestLEScan === "function") {
      try {
        scan = await navigator.bluetooth.requestLEScan({
          acceptAllAdvertisements: true
        });

        navigator.bluetooth.addEventListener("advertisementreceived", onAdv);
        btnStart.disabled = true;
        btnStop.disabled = false;
        ensureRefreshTimer();
        log("开始扫描：requestLEScan 已启动（将持续接收周边广播事件）");
        return;
      } catch (e) {
        log("requestLEScan 启动失败：" + (e?.message || e));
        log("将尝试降级到 requestDevice（只能手动选设备，且通常拿不到 RSSI）");
      }
    } else {
      log("当前浏览器没有 requestLEScan（Scanning API 不可用）。尝试降级到 requestDevice。");
    }

    // 降级：requestDevice（不是“被动扫描所有广播”）
    try {
      const device = await navigator.bluetooth.requestDevice({
        acceptAllDevices: true,
        optionalServices: []
      });
      upsertRow({ name: device.name, id: device.id, rssi: undefined, advDevice: device });
      ensureRefreshTimer();
      log(`已选择设备：${device.name || "(无名称)"}`);
    } catch (e) {
      log("requestDevice 失败：" + (e?.message || e));
    }
  }

  function stopScan() {
    try { scan?.stop(); } catch (_) {}
    scan = null;

    navigator.bluetooth.removeEventListener("advertisementreceived", onAdv);
    btnStart.disabled = false;
    btnStop.disabled = true;

    // 仍然保留“10秒窗口”的衰减显示（已连接的不清）
    ensureRefreshTimer();
    log("已停止扫描（列表将仅保留最近10秒出现的设备；已连接设备不会自动消失）");
  }

  function onAdv(event) {
    const dev = event.device;
    upsertRow({
      name: dev?.name,
      id: dev?.id || "(unknown-id)",
      rssi: event.rssi,
      advDevice: dev
    });
  }

  async function connectEntry(entry) {
    if (entry.connecting) return;
    entry.connecting = true;
    setButtonState(entry, "connecting");

    try {
      // 为了更稳妥：点击“连接”时使用 requestDevice() 走一次“用户选择授权”
      let device = null;

      if (entry.name && entry.name !== "(无名称)") {
        device = await navigator.bluetooth.requestDevice({
          filters: [{ name: entry.name }],
          optionalServices: []
        });
      } else {
        device = await navigator.bluetooth.requestDevice({
          acceptAllDevices: true,
          optionalServices: []
        });
      }

      entry.grantedDevice = device;

      device.addEventListener("gattserverdisconnected", () => {
        entry.connected = false;
        entry.connecting = false;
        entry.gattServer = null;
        setButtonState(entry, "idle");
        showDetails(entry, "(已断开)", true);
        log(`设备断开：${device.name || "(无名称)"}`);
      });

      const server = await device.gatt.connect();
      entry.gattServer = server;
      entry.connected = true;
      entry.connecting = false;
      setButtonState(entry, "connected");
      log(`已连接：${device.name || "(无名称)"}`);

      await enumerateGATT(entry, server);
    } catch (e) {
      entry.connecting = false;
      entry.connected = false;
      entry.gattServer = null;
      setButtonState(entry, "idle");
      showDetails(entry, `<span class="err">连接失败：${escapeHtml(e?.message || e)}</span>`, true);
      log("连接失败：" + (e?.message || e));
    }
  }

  async function disconnectEntry(entry) {
    try {
      const device = entry.grantedDevice || entry.advDevice || entry.gattServer?.device;
      if (device?.gatt?.connected) device.gatt.disconnect();
    } catch (_) {}

    entry.connected = false;
    entry.connecting = false;
    entry.gattServer = null;
    setButtonState(entry, "idle");
    showDetails(entry, "(已断开)", true);
    log(`已断开：${entry.grantedDevice?.name || entry.name || "(无名称)"}`);
  }

  function showDetails(entry, html, open) {
    if (!entry.detailsTr) return;
    const details = entry.detailsTr.querySelector("details");
    const body = entry.detailsTr.querySelector(".detailBody");
    if (body) body.innerHTML = html;
    entry.detailsTr.style.display = "";
    if (details && open) details.open = true;
  }

  async function enumerateGATT(entry, server) {
    try {
      const services = await server.getPrimaryServices();
      if (!services || services.length === 0) {
        showDetails(entry, "(未发现 Primary Services)", true);
        return;
      }

      const parts = [];
      for (const svc of services) {
        let chars = null;
        try {
          chars = await svc.getCharacteristics();
        } catch (e) {
          chars = null;
        }

        const svcUuid = svc.uuid;
        let svcBlock = `<div class="svc"><div class="svcTitle">Service: <span class="mono">${escapeHtml(svcUuid)}</span></div>`;
        if (!chars) {
          svcBlock += `<div class="err">无法读取 Characteristics（可能未授权或设备限制）</div>`;
        } else if (chars.length === 0) {
          svcBlock += `<div>(无 Characteristics)</div>`;
        } else {
          svcBlock += `<ul>`;
          for (const ch of chars) {
            const props = [];
            const p = ch.properties;
            if (p.read) props.push("read");
            if (p.write) props.push("write");
            if (p.writeWithoutResponse) props.push("writeWithoutResponse");
            if (p.notify) props.push("notify");
            if (p.indicate) props.push("indicate");
            if (p.authenticatedSignedWrites) props.push("signedWrites");

            svcBlock += `<li>
              <span>Characteristic: <span class="mono">${escapeHtml(ch.uuid)}</span></span>
              <span class="chip">${escapeHtml(props.join(", ") || "no-props")}</span>
            </li>`;
          }
          svcBlock += `</ul>`;
        }
        svcBlock += `</div>`;
        parts.push(svcBlock);
      }

      showDetails(entry, parts.join(""), true);
    } catch (e) {
      showDetails(entry, `<span class="err">枚举失败：${escapeHtml(e?.message || e)}</span>`, true);
      log("枚举服务失败：" + (e?.message || e));
    }
  }

  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, (c) => ({
      "&": "&amp;",
      "<": "&lt;",
      ">": "&gt;",
      '"': "&quot;",
      "'": "&#39;"
    }[c]));
  }

  btnStart.addEventListener("click", startScan);
  btnStop.addEventListener("click", stopScan);
  btnClear.addEventListener("click", clearTable);

  log("页面已加载。请点击“开始扫描”。");
})();
</script>
</body>
</html>
