<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BLE 扫描（Web Bluetooth）示例</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 16px; }
    button { padding: 10px 14px; margin-right: 8px; }
    .hint { color: #666; margin: 10px 0 14px; line-height: 1.5; }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    th, td { border: 1px solid #ddd; padding: 8px; font-size: 14px; }
    th { background: #f6f6f6; text-align: left; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    #log { white-space: pre-wrap; background: #0b1020; color: #d7e3ff; padding: 10px; border-radius: 8px; margin-top: 12px; }
  </style>
</head>
<body>
  <h2>BLE 扫描（Web Bluetooth）</h2>

  <div class="hint">
    <b>重要限制：</b>网页拿不到 BLE 的真实 MAC 地址；出于隐私原因 Web Bluetooth 也不会暴露 MAC。<br/>
    <b>RSSI 扫描：</b>需要 Chrome(安卓) 并通常要在 <span class="mono">chrome://flags/#enable-experimental-web-platform-features</span> 开启实验特性。<br/>
    <b>环境：</b>必须 HTTPS 或 localhost。
  </div>

  <div>
    <button id="btnStart">开始扫描</button>
    <button id="btnStop" disabled>停止扫描</button>
    <button id="btnClear">清空列表</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>名称</th>
        <th>RSSI</th>
        <th>最近一次出现</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <div id="log"></div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);
  const tbody = $("tbody");
  const logEl = $("log");
  const btnStart = $("btnStart");
  const btnStop = $("btnStop");
  const btnClear = $("btnClear");

  // 只显示最近 10 秒出现过的设备
  const MAX_AGE_MS = 10_000;
  // 刷新 UI 频率（排序 + 过期剔除）
  const REFRESH_MS = 500;

  /** @type {BluetoothLEScan|null} */
  let scan = null;

  /** @type {number|null} */
  let refreshTimer = null;

  // 用 device.id 做“唯一键”（不显示在表格里）
  // id => { tr, lastSeenMs, rssi, name }
  const rows = new Map();

  function log(msg) {
    const t = new Date().toLocaleString();
    logEl.textContent = `[${t}] ${msg}\n` + logEl.textContent;
  }

  function ensureRefreshTimer() {
    if (refreshTimer !== null) return;
    refreshTimer = window.setInterval(refreshView, REFRESH_MS);
  }

  function stopRefreshTimer() {
    if (refreshTimer === null) return;
    window.clearInterval(refreshTimer);
    refreshTimer = null;
  }

  function upsertRow({ name, id, rssi }) {
    const now = Date.now();
    let entry = rows.get(id);

    if (!entry) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="name"></td>
        <td class="mono rssi"></td>
        <td class="mono last"></td>
      `;
      tbody.appendChild(tr);

      entry = { tr, lastSeenMs: now, rssi: undefined, name: "" };
      rows.set(id, entry);
    }

    entry.lastSeenMs = now;
    entry.name = name || "(无名称)";
    entry.rssi = (typeof rssi === "number") ? rssi : undefined;

    entry.tr.querySelector(".name").textContent = entry.name;
    entry.tr.querySelector(".rssi").textContent = (typeof entry.rssi === "number") ? `${entry.rssi} dBm` : "(未知)";
    entry.tr.querySelector(".last").textContent = new Date(now).toLocaleTimeString();

    // 立刻触发一次排序/过期处理（更“跟手”）
    refreshView();
  }

  function refreshView() {
    const now = Date.now();

    // 1) 剔除 10 秒未出现过的设备
    for (const [id, entry] of rows.entries()) {
      if (now - entry.lastSeenMs > MAX_AGE_MS) {
        entry.tr.remove();
        rows.delete(id);
      }
    }

    // 2) 按 RSSI 自动排序（RSSI 越大越靠前，例如 -35 > -80）
    const entries = Array.from(rows.values());
    entries.sort((a, b) => {
      const ar = (typeof a.rssi === "number") ? a.rssi : -Infinity;
      const br = (typeof b.rssi === "number") ? b.rssi : -Infinity;
      if (br !== ar) return br - ar;
      // RSSI 相同就按最近出现时间
      return b.lastSeenMs - a.lastSeenMs;
    });

    // 3) 重新按顺序挂载（appendChild 会移动已存在节点）
    for (const e of entries) {
      tbody.appendChild(e.tr);
    }
  }

  function clearTable() {
    rows.clear();
    tbody.innerHTML = "";
    log("已清空列表");
  }

  async function startScan() {
    if (!("bluetooth" in navigator)) {
      log("当前浏览器不支持 Web Bluetooth（navigator.bluetooth 不存在）");
      return;
    }

    // 优先使用 Scanning API（能拿 RSSI）
    if (typeof navigator.bluetooth.requestLEScan === "function") {
      try {
        scan = await navigator.bluetooth.requestLEScan({
          acceptAllAdvertisements: true
        });

        navigator.bluetooth.addEventListener("advertisementreceived", onAdv);
        btnStart.disabled = true;
        btnStop.disabled = false;
        ensureRefreshTimer();
        log("开始扫描：requestLEScan 已启动（将持续接收周边广播事件）");
        return;
      } catch (e) {
        log("requestLEScan 启动失败：" + (e?.message || e));
        log("将尝试降级到 requestDevice（只能手动选设备，且通常拿不到 RSSI）");
      }
    } else {
      log("当前浏览器没有 requestLEScan（Scanning API 不可用）。尝试降级到 requestDevice。");
    }

    // 降级：requestDevice（不是“被动扫描所有广播”）
    try {
      const device = await navigator.bluetooth.requestDevice({
        acceptAllDevices: true,
        optionalServices: []
      });
      upsertRow({ name: device.name, id: device.id, rssi: undefined });
      ensureRefreshTimer();
      log(`已选择设备：${device.name || "(无名称)"}`);
    } catch (e) {
      log("requestDevice 失败：" + (e?.message || e));
    }
  }

  function stopScan() {
    try {
      if (scan) scan.stop();
    } catch (_) {}
    scan = null;

    navigator.bluetooth.removeEventListener("advertisementreceived", onAdv);
    btnStart.disabled = false;
    btnStop.disabled = true;

    // 仍然保留“10秒窗口”的衰减显示：停止扫描后，最多 10 秒列表会自动清空
    ensureRefreshTimer();
    log("已停止扫描（列表将仅保留最近10秒出现的设备）");
  }

  function onAdv(event) {
    const dev = event.device;
    upsertRow({
      name: dev?.name,
      id: dev?.id || "(unknown-id)",
      rssi: event.rssi
    });
  }

  btnStart.addEventListener("click", startScan);
  btnStop.addEventListener("click", stopScan);
  btnClear.addEventListener("click", clearTable);

  log("页面已加载。请点击“开始扫描”。");
})();
</script>
</body>
</html>
